<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Spring Aop | xuchaoのblog</title><meta name="keywords" content="spring"><meta name="author" content="xuchao"><meta name="copyright" content="xuchao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Spring AOP什么是aop官方引用文档官网是这么说的：Aspect-oriented Programming (AOP)面向切面的编程（AOP）通过提供另一种思考程序结构的方式来补充切面对象的编程（OOP）。OOP中模块化的关键单位是类，而AOP中模块化的单位是方面。切面使跨越多种类型和对象的关注点（如事务管理）模块化。(这种关注点在AOP文献中通常被称为 “横切”）。 Spring框架对A">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Aop">
<meta property="og:url" content="https://xuchao6969.github.io/2022/10/03/SpringAop/index.html">
<meta property="og:site_name" content="xuchaoのblog">
<meta property="og:description" content="Spring AOP什么是aop官方引用文档官网是这么说的：Aspect-oriented Programming (AOP)面向切面的编程（AOP）通过提供另一种思考程序结构的方式来补充切面对象的编程（OOP）。OOP中模块化的关键单位是类，而AOP中模块化的单位是方面。切面使跨越多种类型和对象的关注点（如事务管理）模块化。(这种关注点在AOP文献中通常被称为 “横切”）。 Spring框架对A">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xuchao6969.github.io/img/shaosiming.jpg">
<meta property="article:published_time" content="2022-10-03T13:20:51.000Z">
<meta property="article:modified_time" content="2023-04-11T10:16:52.238Z">
<meta property="article:author" content="xuchao">
<meta property="article:tag" content="spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xuchao6969.github.io/img/shaosiming.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://xuchao6969.github.io/2022/10/03/SpringAop/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50000,"languages":{"author":"作者: xuchao","link":"链接: ","source":"来源: xuchaoのblog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring Aop',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-11 18:16:52'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/leiwujie1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/shaosiming.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">xuchaoのblog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Spring Aop</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-03T13:20:51.000Z" title="发表于 2022-10-03 21:20:51">2022-10-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-04-11T10:16:52.238Z" title="更新于 2023-04-11 18:16:52">2023-04-11</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>35分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h2><h2 id="什么是aop"><a href="#什么是aop" class="headerlink" title="什么是aop"></a>什么是aop</h2><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/5.2.23.RELEASE/spring-framework-reference/core.html#aop">官方引用文档</a><br>官网是这么说的：Aspect-oriented Programming (AOP)面向切面的编程（AOP）通过提供另一种思考程序结构的方式来补充切面对象的编程（OOP）。OOP中模块化的关键单位是类，而AOP中模块化的单位是方面。切面使跨越多种类型和对象的关注点（如事务管理）模块化。(这种关注点在AOP文献中通常被称为 “横切”）。</p>
<h2 id="Spring框架对Aop的使用"><a href="#Spring框架对Aop的使用" class="headerlink" title="Spring框架对Aop的使用"></a>Spring框架对Aop的使用</h2><ul>
<li>提供了声明式的企业级服务特别是声明式的事务管理</li>
<li>让用户实现自定义切面，使用AOP来补充完善他们面向对象</li>
</ul>
<h2 id="AOP的概念"><a href="#AOP的概念" class="headerlink" title="AOP的概念"></a>AOP的概念</h2><ul>
<li><p>Aspect切面：一个跨越多个类的关注点的模块化。在Spring AOP中，切面是通过使用常规类（基于xml）或使用@Aspect注解的常规类（@AspectJ风格）来实现的。 切面由切点和增强&#x2F;通知组成，它既包括了横切逻辑的定义、也包括了连接点的定义。<br>人话：切面由切点和增强组成，它既包括了横切逻辑的定义、也包括了连接点的定义。通俗点就是在什么时机，什么地方，做什么增强；</p>
</li>
<li><p>Join Point连接点：在程序执行过程中的一个点，例如一个方法的执行或一个异常的处理。在Spring AOP中，一个连接点总是代表一个方法的执行。<br>人话：AOP是基于代理的，不管jdk代理还是cglib代理，拦截的总是业务方法，所以连接点可以理解为我们的业务方法。</p>
</li>
<li><p>Advice增强(通知)：一个切面在一个特定的连接点采取的行动。不同类型的增强包括 “around”、”before “和 “after “。(许多AOP框架，包括Spring，都将增强建模为一个拦截器，并在连接点周围维护一个拦截器链。<br>人话：表示添加到切点的一段逻辑代码，并定位连接点的方位信息，简单来说就定义了是干什么的，具体是在哪干；在方法执行的什么时机（方法前&#x2F;方法后&#x2F;方法前后）做什么</p>
</li>
<li><p>PointCut切点：一个匹配连接点的谓词。增强与一个切点表达式相关联，并在切点匹配的任何连接点上运行(例如，执行一个特定名称的方法)由切点表达式匹配的连接点概念是AOP的核心，Spring默认使用AspectJ的切点表达式语言。可以理解为具体要执行切面逻辑的方法<br>人话：在哪些类，哪些方法上切入</p>
</li>
<li><p>Introduction引入：代表一种类型声明额外的方法或字段。Spring AOP允许你为任何介入的对象引入新的接口(以及相应的实现),例如，你可以使用引入来使一个bean实现IsModified接口，以简化缓存。(引入在AspectJ社区中被称为类型间声明）。<br>人话：为现有的类添加新方法或字段，是一种特殊的增强</p>
</li>
<li><p>Target object目标对象:被一个或多个切面所介入的对象。也被称为 “介入对象”。由于Spring AOP是通过使用运行时代理来实现的，这个对象总是一个被代理的对象。</p>
</li>
<li><p>AOP proxy代理：一个由AOP框架创建的对象，以实现切面（介入方法执行等）。在Spring框架中，AOP代理是一个JDK动态代理或CGLIB代理。</p>
</li>
<li><p>Weaving织入：将aspect与其他应用程序类型或对象连接起来，以创建一个介入对象。这可以在编译时（例如，使用AspectJ编译器）、加载时或运行时完成。Spring AOP和其他纯Java AOP框架一样，在运行时进行织入。<br>人话：把切面加入到目标对象，并创建出代理对象的过程</p>
</li>
</ul>
<h2 id="增强类型"><a href="#增强类型" class="headerlink" title="增强类型"></a>增强类型</h2><ul>
<li>Before advice前置增强：在目标方法被调用前执行(即使目标方法抛异常他也会执行，除非自己抛异常)</li>
<li>After returning advice返回后增强：在目标方法成功执行之后(成功执行指的是方法没有抛出异常)</li>
<li>After throwing advice异常后增强：在目标方法抛异常后执行(方法没抛异常，这个增强不执行)</li>
<li>After (finally) advice方法后增强：在目标方法后执行(不管目标方法是异常退出还是正常执行完毕，最后都会执行这个增强)</li>
<li>Around advice环绕增强：在目标方法前后各执行一次该增强(并且可以在增强逻辑内提前返回或者抛异常来短路目标方法的执行)</li>
</ul>
<h2 id="调用流程"><a href="#调用流程" class="headerlink" title="调用流程"></a>调用流程</h2><p>这个着实有点长了，从入口到整个流程，以及调用链路都标了出来，小佩服自己一下(图片可以放大查看，不失真)<br><img src="/img/SpringAop/aop.png" width="100px" height= "400px"/></p>
<h2 id="spring的版本是5-3-23"><a href="#spring的版本是5-3-23" class="headerlink" title="spring的版本是5.3.23"></a>spring的版本是5.3.23</h2><p><a target="_blank" rel="noopener" href="https://github.com/xuchao6969/demo/tree/master/spring-aop">demo地址:</a> </p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="SpringApplication-run-SpringTransactionApplication-class-args"><a href="#SpringApplication-run-SpringTransactionApplication-class-args" class="headerlink" title="SpringApplication.run(SpringTransactionApplication.class, args);"></a>SpringApplication.run(SpringTransactionApplication.class, args);</h3><p>对应流程图中的1<br>启动springboot程序，会首先进入到SpringApplication#run方法(3层调用才进入)<br>在这个方法中进行ApplicationContext的创建以及刷新，目的是完成项目所需要spring环境配置和其他依赖配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">   //首先看到这个方法的返回值是ConfigurableApplicationContext 很自然就可以想到这个类直接或间接继承了ApplicationContext然后直接或间接继承了BeanFactory</span><br><span class="line">   //拿到BeanFactory 可以做很多事情，获取bean真的是简简单单了	</span><br><span class="line">   public ConfigurableApplicationContext run(String... args) &#123;</span><br><span class="line">	long startTime = System.nanoTime();</span><br><span class="line">	//创建springboot默认的配置上下文</span><br><span class="line">	DefaultBootstrapContext bootstrapContext = createBootstrapContext();</span><br><span class="line">	ConfigurableApplicationContext context = null;</span><br><span class="line">	configureHeadlessProperty();</span><br><span class="line">	//通过类加载器创建spring工厂实例并注册启动监听器</span><br><span class="line">	SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">	listeners.starting(bootstrapContext, this.mainApplicationClass);</span><br><span class="line">	try &#123;</span><br><span class="line">	        //处理参数args成CommandLineArgs对象，具体是把参数分为optionArgs和nonOptionArgs来给下边的环境配置使用</span><br><span class="line">		ApplicationArguments applicationArguments = new DefaultApplicationArguments(args);</span><br><span class="line">		ConfigurableEnvironment environment = prepareEnvironment(listeners, bootstrapContext, applicationArguments);</span><br><span class="line">		configureIgnoreBeanInfo(environment);</span><br><span class="line">		Banner printedBanner = printBanner(environment);</span><br><span class="line">		//创建ConfigurableApplicationContext为单例bean的创建和初始化进行做准备</span><br><span class="line">		context = createApplicationContext();</span><br><span class="line">		context.setApplicationStartup(this.applicationStartup);</span><br><span class="line">		prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">		//这个方法是容器初始化的入口，在方法中调用SpringApplication#refresh方法</span><br><span class="line">		refreshContext(context);</span><br><span class="line">		afterRefresh(context, applicationArguments);</span><br><span class="line">		Duration timeTakenToStartup = Duration.ofNanos(System.nanoTime() - startTime);</span><br><span class="line">		if (this.logStartupInfo) &#123;</span><br><span class="line">			new StartupInfoLogger(this.mainApplicationClass).logStarted(getApplicationLog(), timeTakenToStartup);</span><br><span class="line">		&#125;</span><br><span class="line">		listeners.started(context, timeTakenToStartup);</span><br><span class="line">		callRunners(context, applicationArguments);</span><br><span class="line">	&#125;</span><br><span class="line">	catch (Throwable ex) &#123;</span><br><span class="line">		···</span><br><span class="line">	&#125;</span><br><span class="line">	try &#123;</span><br><span class="line">		···</span><br><span class="line">	&#125;</span><br><span class="line">	catch (Throwable ex) &#123;</span><br><span class="line">		···</span><br><span class="line">	&#125;</span><br><span class="line">	return context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractApplicationContext-refresh"><a href="#AbstractApplicationContext-refresh" class="headerlink" title="AbstractApplicationContext#refresh"></a>AbstractApplicationContext#refresh</h3><p>对应流程图中的2<br>这个方法在学习生命周期的时候会遇到的第一个方法,这个方法主要做spring容器配置以及bean初始化相关</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public void refresh() throws BeansException, IllegalStateException &#123;</span><br><span class="line">    synchronized(this.startupShutdownMonitor) &#123;</span><br><span class="line">        StartupStep contextRefresh = this.applicationStartup.start(&quot;spring.context.refresh&quot;);</span><br><span class="line"> //准备刷新上下文,具体做一些启动日期和活动标志的设置以及执行一些属性资源的初始化</span><br><span class="line">        this.prepareRefresh();</span><br><span class="line"> //创建BeanFactory 具体的逻辑是 如果存在以前的BeanFactory就销毁Bean关闭工厂，重新创建，重新创建完后会调用</span><br><span class="line"> //setSerializationId(getId());customizeBeanFactory(beanFactory);loadBeanDefinitions(beanFactory);这三方法做一些其他配置，这里不细探究</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = this.obtainFreshBeanFactory();</span><br><span class="line"> //配置工厂的标准上下文特征，例如上下文的类加载器和后处理器，后边还有一大堆的set regist 方法都是装备BeanFactory使其功能更完备</span><br><span class="line">        this.prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">   //在标准初始化之后修改应用程序上下文的内部 Bean 工厂，所有 Bean 定义都将被加载，但尚未实例化任何 bean。这允许在某些 </span><br><span class="line">//ApplicationContext 实现中注册特殊的 BeanPostProcessor，这个是空方法，留给子类做扩展使用</span><br><span class="line">            this.postProcessBeanFactory(beanFactory);</span><br><span class="line">            StartupStep beanPostProcess = this.applicationStartup.start(&quot;spring.context.beans.post-process&quot;);</span><br><span class="line">//实例化并调用所有注册的 BeanFactoryPostProcessor bean，如果给定，则遵守显式顺序，必须在单一实例化之前调用。</span><br><span class="line">            this.invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">//实例化并注册所有 BeanPostProcessor的实现类，如果给定顺序，则遵循显式顺序。必须在应用程序 Bean 的任何实例化之前调用。</span><br><span class="line">            this.registerBeanPostProcessors(beanFactory);</span><br><span class="line">            beanPostProcess.end();</span><br><span class="line">//初始化context的MessageSource，用于消息模块的国际化，有两个实现类ResourceBundleMessageSource\ReloadableResourceBundleMessageSource</span><br><span class="line">            this.initMessageSource();</span><br><span class="line">//初始化应用程序事件多播器。如果上下文中未定义任何内容，则使用 SimpleApplicationEventMulticaster。</span><br><span class="line">            this.initApplicationEventMulticaster();</span><br><span class="line">//子类可以重写用来添加特定于上下文的刷新工作。在实例化单例之前调用特殊 bean 的初始化。</span><br><span class="line">            this.onRefresh();</span><br><span class="line">//添加实现 ApplicationListener 的 bean 作为侦听器。不影响其他侦听器，可以在不成为 bean 的情况下添加这些侦听器。</span><br><span class="line">            this.registerListeners();</span><br><span class="line">//对应流程图中的3</span><br><span class="line">//完成beanFactoryd的初始化工作，实例化剩余的非懒加载的单例bean,spring bean初始化的入口也是核心</span><br><span class="line">            this.finishBeanFactoryInitialization(beanFactory);</span><br><span class="line">//完成此上下文的刷新，调用生命周期处理器的 onRefresh（） 方法并发布 ContextRefreshedEvent。</span><br><span class="line">            this.finishRefresh();</span><br><span class="line">        &#125; catch (BeansException var10) &#123;</span><br><span class="line">            if (this.logger.isWarnEnabled()) &#123;</span><br><span class="line">                this.logger.warn(&quot;Exception encountered during context initialization - cancelling refresh attempt: &quot; + var10);</span><br><span class="line">            &#125;</span><br><span class="line">//销毁单例bean</span><br><span class="line">            this.destroyBeans();</span><br><span class="line">//此context的刷新尝试，在引发异常后重置活动标志。将active置为false</span><br><span class="line">            this.cancelRefresh(var10);</span><br><span class="line">            throw var10;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">   //重置 Spring 的公共的元数据缓存，特别是 ReflectionUtils、AnnotationUtils、ResolvevableType 和 CachedIntrospectionResults 缓存。</span><br><span class="line">            this.resetCommonCaches();</span><br><span class="line">//记录步骤的状态以及可能的其他指标，如执行时间。结束后，不允许更改步骤状态。</span><br><span class="line">            contextRefresh.end();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>中间非核心过程就略过，直接来到实例化前的回调接口处，对应流程图9，调用实例化前的方法bp.postProcessBeforeInstantiation(beanClass, beanName);该方法被好多子类重写，其中AbstractAutoProxyCreator就是Aop创建代理的抽象类。</p>
<h3 id="AbstractAutoProxyCreator-postProcessBeforeInstantiation"><a href="#AbstractAutoProxyCreator-postProcessBeforeInstantiation" class="headerlink" title="AbstractAutoProxyCreator#postProcessBeforeInstantiation"></a>AbstractAutoProxyCreator#postProcessBeforeInstantiation</h3><p>Aop创建代理的抽象类，进行代理创建之前的一些操作<br>对应流程图10</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public Object postProcessBeforeInstantiation(Class&lt;?&gt; beanClass, String beanName) &#123;</span><br><span class="line">	Object cacheKey = getCacheKey(beanClass, beanName);</span><br><span class="line"></span><br><span class="line">	if (!StringUtils.hasLength(beanName) || !this.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">		// 判断缓存中有没有切面bean 第一次是没有的</span><br><span class="line">		if (this.advisedBeans.containsKey(cacheKey)) &#123;</span><br><span class="line">			return null;</span><br><span class="line">		&#125;</span><br><span class="line">		// 看看给定的beanClass是不是不需要代理 对应流程图11</span><br><span class="line">		if (isInfrastructureClass(beanClass) || shouldSkip(beanClass, beanName)) &#123;</span><br><span class="line">			this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">			return null;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Create proxy here if we have a custom TargetSource.</span><br><span class="line">	// Suppresses unnecessary default instantiation of the target bean:</span><br><span class="line">	// The TargetSource will handle target instances in a custom fashion.</span><br><span class="line">	TargetSource targetSource = getCustomTargetSource(beanClass, beanName);</span><br><span class="line">	if (targetSource != null) &#123;</span><br><span class="line">		if (StringUtils.hasLength(beanName)) &#123;</span><br><span class="line">			this.targetSourcedBeans.add(beanName);</span><br><span class="line">		&#125;</span><br><span class="line">		Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource);</span><br><span class="line">		Object proxy = createProxy(beanClass, beanName, specificInterceptors, targetSource);</span><br><span class="line">		this.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">		return proxy;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AspectJAwareAdvisorAutoProxyCreator-shouldSkip"><a href="#AspectJAwareAdvisorAutoProxyCreator-shouldSkip" class="headerlink" title="AspectJAwareAdvisorAutoProxyCreator#shouldSkip"></a>AspectJAwareAdvisorAutoProxyCreator#shouldSkip</h3><p>对应流程图11<br>判断beanClass是否不需要创建代理直接跳过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">protected boolean shouldSkip(Class&lt;?&gt; beanClass, String beanName) &#123;</span><br><span class="line">	// 查找所有切面</span><br><span class="line">	List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors();</span><br><span class="line">	for (Advisor advisor : candidateAdvisors) &#123;</span><br><span class="line">		if (advisor instanceof AspectJPointcutAdvisor &amp;&amp;</span><br><span class="line">				((AspectJPointcutAdvisor) advisor).getAspectName().equals(beanName)) &#123;</span><br><span class="line">			return true;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return super.shouldSkip(beanClass, beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AnnotationAwareAspectJAutoProxyCreator-findCandidateAdvisors"><a href="#AnnotationAwareAspectJAutoProxyCreator-findCandidateAdvisors" class="headerlink" title="AnnotationAwareAspectJAutoProxyCreator#findCandidateAdvisors"></a>AnnotationAwareAspectJAutoProxyCreator#findCandidateAdvisors</h3><p>对应流程图12<br>查询切面信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;Advisor&gt; findCandidateAdvisors() &#123;</span><br><span class="line">	// 调用父类查询切面的方法 这里返回null</span><br><span class="line">	List&lt;Advisor&gt; advisors = super.findCandidateAdvisors();</span><br><span class="line">	</span><br><span class="line">	if (this.aspectJAdvisorsBuilder != null) &#123;</span><br><span class="line">		// 构造切面 对应流程图13</span><br><span class="line">		advisors.addAll(this.aspectJAdvisorsBuilder.buildAspectJAdvisors());</span><br><span class="line">	&#125;</span><br><span class="line">	return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BeanFactoryAspectJAdvisorsBuilder-buildAspectJAdvisors"><a href="#BeanFactoryAspectJAdvisorsBuilder-buildAspectJAdvisors" class="headerlink" title="BeanFactoryAspectJAdvisorsBuilder#buildAspectJAdvisors"></a>BeanFactoryAspectJAdvisorsBuilder#buildAspectJAdvisors</h3><p>对应流程图13<br>在当前 Bean 工厂中查找AspectJ注解的切面bean，得到他们代表的Aop切面，比如说使用@Beafore就会得到before对应的切面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Advisor&gt; buildAspectJAdvisors() &#123;</span><br><span class="line">	List&lt;String&gt; aspectNames = this.aspectBeanNames;</span><br><span class="line"></span><br><span class="line">	if (aspectNames == null) &#123;</span><br><span class="line">		synchronized (this) &#123;</span><br><span class="line">			aspectNames = this.aspectBeanNames;</span><br><span class="line">			if (aspectNames == null) &#123;</span><br><span class="line">				List&lt;Advisor&gt; advisors = new ArrayList&lt;&gt;();</span><br><span class="line">				aspectNames = new ArrayList&lt;&gt;();</span><br><span class="line">				String[] beanNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors(</span><br><span class="line">						this.beanFactory, Object.class, true, false);</span><br><span class="line">				for (String beanName : beanNames) &#123;</span><br><span class="line">					if (!isEligibleBean(beanName)) &#123;</span><br><span class="line">						continue;</span><br><span class="line">					&#125;</span><br><span class="line">					// 获取工厂中的bean类型</span><br><span class="line">					Class&lt;?&gt; beanType = this.beanFactory.getType(beanName, false);</span><br><span class="line">					if (beanType == null) &#123;</span><br><span class="line">						continue;</span><br><span class="line">					&#125;</span><br><span class="line">					// 找到Aspect切面类型 也就是@Aspect注解的类 对应流程图14</span><br><span class="line">					if (this.advisorFactory.isAspect(beanType)) &#123;</span><br><span class="line">						aspectNames.add(beanName);</span><br><span class="line">						AspectMetadata amd = new AspectMetadata(beanType, beanName);</span><br><span class="line">						if (amd.getAjType().getPerClause().getKind() == PerClauseKind.SINGLETON) &#123;</span><br><span class="line">							MetadataAwareAspectInstanceFactory factory =</span><br><span class="line">									new BeanFactoryAspectInstanceFactory(this.beanFactory, beanName);</span><br><span class="line">							// 获取@Aspect类中的切面类型(before、around、···之类的) 对应流程图15</span><br><span class="line">							List&lt;Advisor&gt; classAdvisors = this.advisorFactory.getAdvisors(factory);</span><br><span class="line">							if (this.beanFactory.isSingleton(beanName)) &#123;</span><br><span class="line">								// 拿到对应具体类型切面后放到缓存中</span><br><span class="line">								this.advisorsCache.put(beanName, classAdvisors);</span><br><span class="line">							&#125;</span><br><span class="line">							else &#123;</span><br><span class="line">								this.aspectFactoryCache.put(beanName, factory);</span><br><span class="line">							&#125;</span><br><span class="line">							advisors.addAll(classAdvisors);</span><br><span class="line">						&#125;</span><br><span class="line">						else &#123;</span><br><span class="line">							// Per target or per this.</span><br><span class="line">							if (this.beanFactory.isSingleton(beanName)) &#123;</span><br><span class="line">								throw new IllegalArgumentException(&quot;Bean with name &#x27;&quot; + beanName +</span><br><span class="line">										&quot;&#x27; is a singleton, but aspect instantiation model is not singleton&quot;);</span><br><span class="line">							&#125;</span><br><span class="line">							MetadataAwareAspectInstanceFactory factory =</span><br><span class="line">									new PrototypeAspectInstanceFactory(this.beanFactory, beanName);</span><br><span class="line">							this.aspectFactoryCache.put(beanName, factory);</span><br><span class="line">							advisors.addAll(this.advisorFactory.getAdvisors(factory));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				// 缓存切面名称</span><br><span class="line">				this.aspectBeanNames = aspectNames;</span><br><span class="line">				return advisors;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (aspectNames.isEmpty()) &#123;</span><br><span class="line">		return Collections.emptyList();</span><br><span class="line">	&#125;</span><br><span class="line">	List&lt;Advisor&gt; advisors = new ArrayList&lt;&gt;();</span><br><span class="line">	for (String aspectName : aspectNames) &#123;</span><br><span class="line">		List&lt;Advisor&gt; cachedAdvisors = this.advisorsCache.get(aspectName);</span><br><span class="line">		if (cachedAdvisors != null) &#123;</span><br><span class="line">			advisors.addAll(cachedAdvisors);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			MetadataAwareAspectInstanceFactory factory = this.aspectFactoryCache.get(aspectName);</span><br><span class="line">			advisors.addAll(this.advisorFactory.getAdvisors(factory));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractAspectJAdvisorFactory-isAspect"><a href="#AbstractAspectJAdvisorFactory-isAspect" class="headerlink" title="AbstractAspectJAdvisorFactory#isAspect"></a>AbstractAspectJAdvisorFactory#isAspect</h3><p>对应流程图14<br>判断有没有@Aspect的注解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private boolean hasAspectAnnotation(Class&lt;?&gt; clazz) &#123;</span><br><span class="line">	return (AnnotationUtils.findAnnotation(clazz, Aspect.class) != null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ReflectiveAspectJAdvisorFactory-getAdvisors"><a href="#ReflectiveAspectJAdvisorFactory-getAdvisors" class="headerlink" title="ReflectiveAspectJAdvisorFactory#getAdvisors"></a>ReflectiveAspectJAdvisorFactory#getAdvisors</h3><p>对应流程图15<br>获取切面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Advisor&gt; getAdvisors(MetadataAwareAspectInstanceFactory aspectInstanceFactory) &#123;</span><br><span class="line">	Class&lt;?&gt; aspectClass = aspectInstanceFactory.getAspectMetadata().getAspectClass();</span><br><span class="line">	String aspectName = aspectInstanceFactory.getAspectMetadata().getAspectName();</span><br><span class="line">	validate(aspectClass);</span><br><span class="line"></span><br><span class="line">	// We need to wrap the MetadataAwareAspectInstanceFactory with a decorator</span><br><span class="line">	// so that it will only instantiate once.</span><br><span class="line">	MetadataAwareAspectInstanceFactory lazySingletonAspectInstanceFactory =</span><br><span class="line">			new LazySingletonAspectInstanceFactoryDecorator(aspectInstanceFactory);</span><br><span class="line"></span><br><span class="line">	List&lt;Advisor&gt; advisors = new ArrayList&lt;&gt;();</span><br><span class="line">	for (Method method : getAdvisorMethods(aspectClass)) &#123;</span><br><span class="line">		// 获取切面 对应流程图16</span><br><span class="line">		Advisor advisor = getAdvisor(method, lazySingletonAspectInstanceFactory, 0, aspectName);</span><br><span class="line">		if (advisor != null) &#123;</span><br><span class="line">			advisors.add(advisor);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// If it&#x27;s a per target aspect, emit the dummy instantiating aspect.</span><br><span class="line">	if (!advisors.isEmpty() &amp;&amp; lazySingletonAspectInstanceFactory.getAspectMetadata().isLazilyInstantiated()) &#123;</span><br><span class="line">		//···</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Find introduction fields.</span><br><span class="line">	for (Field field : aspectClass.getDeclaredFields()) &#123;</span><br><span class="line">		//···</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ReflectiveAspectJAdvisorFactory-getAdvisor"><a href="#ReflectiveAspectJAdvisorFactory-getAdvisor" class="headerlink" title="ReflectiveAspectJAdvisorFactory#getAdvisor"></a>ReflectiveAspectJAdvisorFactory#getAdvisor</h3><p>对应流程图16</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public Advisor getAdvisor(Method candidateAdviceMethod, MetadataAwareAspectInstanceFactory aspectInstanceFactory,</span><br><span class="line">		int declarationOrderInAspect, String aspectName) &#123;</span><br><span class="line"></span><br><span class="line">	validate(aspectInstanceFactory.getAspectMetadata().getAspectClass());</span><br><span class="line"></span><br><span class="line">	AspectJExpressionPointcut expressionPointcut = getPointcut(</span><br><span class="line">			candidateAdviceMethod, aspectInstanceFactory.getAspectMetadata().getAspectClass());</span><br><span class="line">	if (expressionPointcut == null) &#123;</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line">	// 包装切面实现 对应流程图17</span><br><span class="line">	return new InstantiationModelAwarePointcutAdvisorImpl(expressionPointcut, candidateAdviceMethod,</span><br><span class="line">			this, aspectInstanceFactory, declarationOrderInAspect, aspectName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="InstantiationModelAwarePointcutAdvisorImpl构造方法"><a href="#InstantiationModelAwarePointcutAdvisorImpl构造方法" class="headerlink" title="InstantiationModelAwarePointcutAdvisorImpl构造方法"></a>InstantiationModelAwarePointcutAdvisorImpl构造方法</h3><p>对应流程图17</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public InstantiationModelAwarePointcutAdvisorImpl(AspectJExpressionPointcut declaredPointcut,</span><br><span class="line">		Method aspectJAdviceMethod, AspectJAdvisorFactory aspectJAdvisorFactory,</span><br><span class="line">		MetadataAwareAspectInstanceFactory aspectInstanceFactory, int declarationOrder, String aspectName) &#123;</span><br><span class="line"></span><br><span class="line">	this.declaredPointcut = declaredPointcut;</span><br><span class="line">	this.declaringClass = aspectJAdviceMethod.getDeclaringClass();</span><br><span class="line">	this.methodName = aspectJAdviceMethod.getName();</span><br><span class="line">	this.parameterTypes = aspectJAdviceMethod.getParameterTypes();</span><br><span class="line">	this.aspectJAdviceMethod = aspectJAdviceMethod;</span><br><span class="line">	this.aspectJAdvisorFactory = aspectJAdvisorFactory;</span><br><span class="line">	this.aspectInstanceFactory = aspectInstanceFactory;</span><br><span class="line">	this.declarationOrder = declarationOrder;</span><br><span class="line">	this.aspectName = aspectName;</span><br><span class="line"></span><br><span class="line">	if (aspectInstanceFactory.getAspectMetadata().isLazilyInstantiated()) &#123;</span><br><span class="line">		// Static part of the pointcut is a lazy type.</span><br><span class="line">		Pointcut preInstantiationPointcut = Pointcuts.union(</span><br><span class="line">				aspectInstanceFactory.getAspectMetadata().getPerClausePointcut(), this.declaredPointcut);</span><br><span class="line"></span><br><span class="line">		// Make it dynamic: must mutate from pre-instantiation to post-instantiation state.</span><br><span class="line">		// If it&#x27;s not a dynamic pointcut, it may be optimized out</span><br><span class="line">		// by the Spring AOP infrastructure after the first evaluation.</span><br><span class="line">		this.pointcut = new PerTargetInstantiationModelPointcut(</span><br><span class="line">				this.declaredPointcut, preInstantiationPointcut, aspectInstanceFactory);</span><br><span class="line">		this.lazy = true;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		// A singleton aspect.</span><br><span class="line">		this.pointcut = this.declaredPointcut;</span><br><span class="line">		this.lazy = false;</span><br><span class="line">		// 实例化切面 对应流程图18</span><br><span class="line">		this.instantiatedAdvice = instantiateAdvice(this.declaredPointcut);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="InstantiationModelAwarePointcutAdvisorImpl-instantiateAdvice"><a href="#InstantiationModelAwarePointcutAdvisorImpl-instantiateAdvice" class="headerlink" title="InstantiationModelAwarePointcutAdvisorImpl#instantiateAdvice"></a>InstantiationModelAwarePointcutAdvisorImpl#instantiateAdvice</h3><p>对应流程图18<br>实例化切面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private Advice instantiateAdvice(AspectJExpressionPointcut pointcut) &#123;</span><br><span class="line">	// 获取切面 对应流程图19</span><br><span class="line">	Advice advice = this.aspectJAdvisorFactory.getAdvice(this.aspectJAdviceMethod, pointcut,</span><br><span class="line">			this.aspectInstanceFactory, this.declarationOrder, this.aspectName);</span><br><span class="line">	return (advice != null ? advice : EMPTY_ADVICE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ReflectiveAspectJAdvisorFactory-getAdvice"><a href="#ReflectiveAspectJAdvisorFactory-getAdvice" class="headerlink" title="ReflectiveAspectJAdvisorFactory#getAdvice"></a>ReflectiveAspectJAdvisorFactory#getAdvice</h3><p>对应流程图19<br>获取具体类型切面的示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">public Advice getAdvice(Method candidateAdviceMethod, AspectJExpressionPointcut expressionPointcut,</span><br><span class="line">		MetadataAwareAspectInstanceFactory aspectInstanceFactory, int declarationOrder, String aspectName) &#123;</span><br><span class="line"></span><br><span class="line">	Class&lt;?&gt; candidateAspectClass = aspectInstanceFactory.getAspectMetadata().getAspectClass();</span><br><span class="line">	validate(candidateAspectClass);</span><br><span class="line"></span><br><span class="line">	AspectJAnnotation&lt;?&gt; aspectJAnnotation =</span><br><span class="line">			AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(candidateAdviceMethod);</span><br><span class="line">	if (aspectJAnnotation == null) &#123;</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 走到这里，说明有@Aspect类型标注的方法</span><br><span class="line">	if (!isAspect(candidateAspectClass)) &#123;</span><br><span class="line">		throw new AopConfigException(&quot;Advice must be declared inside an aspect type: &quot; +</span><br><span class="line">				&quot;Offending method &#x27;&quot; + candidateAdviceMethod + &quot;&#x27; in class [&quot; +</span><br><span class="line">				candidateAspectClass.getName() + &quot;]&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (logger.isDebugEnabled()) &#123;</span><br><span class="line">		logger.debug(&quot;Found AspectJ method: &quot; + candidateAdviceMethod);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	AbstractAspectJAdvice springAdvice;</span><br><span class="line"></span><br><span class="line">	switch (aspectJAnnotation.getAnnotationType()) &#123;</span><br><span class="line">		// 切点</span><br><span class="line">		case AtPointcut:</span><br><span class="line">			if (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(&quot;Processing pointcut &#x27;&quot; + candidateAdviceMethod.getName() + &quot;&#x27;&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			return null;</span><br><span class="line">		// around类型	</span><br><span class="line">		case AtAround:</span><br><span class="line">			springAdvice = new AspectJAroundAdvice(</span><br><span class="line">					candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);</span><br><span class="line">			break;</span><br><span class="line">		// before类型	</span><br><span class="line">		case AtBefore:</span><br><span class="line">			springAdvice = new AspectJMethodBeforeAdvice(</span><br><span class="line">					candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);</span><br><span class="line">			break;</span><br><span class="line">		// after类型</span><br><span class="line">		case AtAfter:</span><br><span class="line">			springAdvice = new AspectJAfterAdvice(</span><br><span class="line">					candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);</span><br><span class="line">			break;</span><br><span class="line">		// afterReturning</span><br><span class="line">		case AtAfterReturning:</span><br><span class="line">			springAdvice = new AspectJAfterReturningAdvice(</span><br><span class="line">					candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);</span><br><span class="line">			AfterReturning afterReturningAnnotation = (AfterReturning) aspectJAnnotation.getAnnotation();</span><br><span class="line">			if (StringUtils.hasText(afterReturningAnnotation.returning())) &#123;</span><br><span class="line">				springAdvice.setReturningName(afterReturningAnnotation.returning());</span><br><span class="line">			&#125;</span><br><span class="line">			break;</span><br><span class="line">		// afterThrowing	</span><br><span class="line">		case AtAfterThrowing:</span><br><span class="line">			springAdvice = new AspectJAfterThrowingAdvice(</span><br><span class="line">					candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);</span><br><span class="line">			AfterThrowing afterThrowingAnnotation = (AfterThrowing) aspectJAnnotation.getAnnotation();</span><br><span class="line">			if (StringUtils.hasText(afterThrowingAnnotation.throwing())) &#123;</span><br><span class="line">				springAdvice.setThrowingName(afterThrowingAnnotation.throwing());</span><br><span class="line">			&#125;</span><br><span class="line">			break;</span><br><span class="line">		default:</span><br><span class="line">			throw new UnsupportedOperationException(</span><br><span class="line">					&quot;Unsupported advice type on method: &quot; + candidateAdviceMethod);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Now to configure the advice...</span><br><span class="line">	springAdvice.setAspectName(aspectName);</span><br><span class="line">	springAdvice.setDeclarationOrder(declarationOrder);</span><br><span class="line">	String[] argNames = this.parameterNameDiscoverer.getParameterNames(candidateAdviceMethod);</span><br><span class="line">	if (argNames != null) &#123;</span><br><span class="line">		springAdvice.setArgumentNamesFromStringArray(argNames);</span><br><span class="line">	&#125;</span><br><span class="line">	springAdvice.calculateArgumentBindings();</span><br><span class="line"></span><br><span class="line">	return springAdvice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h3><p>流程图1~流程图13 在容器初始化完成后，spring就会遍历所有的类，寻找@Aspect注解标注的切面，辨别5中类型的具体切面示例然后放到缓存中advisorsCache中，这一部分的入口是postProcessBeforeInstantiation，bean实例化之前完成的</p>
<p>走到这里前置工作都已经准备完成了该有的切面都有了，继续往下执行会进入coCreateBean方法以及initializeBean方法，然后进入实例化后置回调方法AbstractAutoProxyCreator#postProcessAfterInitialization方法，对应流程图24</p>
<h3 id="AbstractAutoProxyCreator-postProcessAfterInitialization"><a href="#AbstractAutoProxyCreator-postProcessAfterInitialization" class="headerlink" title="AbstractAutoProxyCreator#postProcessAfterInitialization"></a>AbstractAutoProxyCreator#postProcessAfterInitialization</h3><p>对应流程图24<br>Aop创建代理的抽象类AbstractAutoProxyCreator，之前流程图10已经见过这个类了，那时候主要是获取切面相关的信息然后放到缓存中。现在是做一些创建代理相关的工作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) &#123;</span><br><span class="line">	if (bean != null) &#123;</span><br><span class="line">		Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br><span class="line">		if (this.earlyProxyReferences.remove(cacheKey) != bean) &#123;</span><br><span class="line">			// 获取切面 创建代理 对应流程图25</span><br><span class="line">			return wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractAutoProxyCreator-wrapIfNecessary"><a href="#AbstractAutoProxyCreator-wrapIfNecessary" class="headerlink" title="AbstractAutoProxyCreator#wrapIfNecessary"></a>AbstractAutoProxyCreator#wrapIfNecessary</h3><p>对应流程图25<br>获取切面 创建代理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123;</span><br><span class="line">	if (StringUtils.hasLength(beanName) &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">		return bean;</span><br><span class="line">	&#125;</span><br><span class="line">	if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line">		return bean;</span><br><span class="line">	&#125;</span><br><span class="line">	if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line">		this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">		return bean;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 获取切面 对应流程图26</span><br><span class="line">	Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);</span><br><span class="line">	if (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line">		this.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line">		Object proxy = createProxy(</span><br><span class="line">				bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));</span><br><span class="line">		this.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">		return proxy;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">	return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractAdvisorAutoProxyCreator-getAdvicesAndAdvisorsForBean"><a href="#AbstractAdvisorAutoProxyCreator-getAdvicesAndAdvisorsForBean" class="headerlink" title="AbstractAdvisorAutoProxyCreator#getAdvicesAndAdvisorsForBean"></a>AbstractAdvisorAutoProxyCreator#getAdvicesAndAdvisorsForBean</h3><p>对应流程图26<br>获取切面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">protected Object[] getAdvicesAndAdvisorsForBean(</span><br><span class="line">		Class&lt;?&gt; beanClass, String beanName, @Nullable TargetSource targetSource) &#123;</span><br><span class="line">	// 获取切面 对应流程图27</span><br><span class="line">	List&lt;Advisor&gt; advisors = findEligibleAdvisors(beanClass, beanName);</span><br><span class="line">	if (advisors.isEmpty()) &#123;</span><br><span class="line">		return DO_NOT_PROXY;</span><br><span class="line">	&#125;</span><br><span class="line">	return advisors.toArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractAdvisorAutoProxyCreator-findEligibleAdvisors"><a href="#AbstractAdvisorAutoProxyCreator-findEligibleAdvisors" class="headerlink" title="AbstractAdvisorAutoProxyCreator#findEligibleAdvisors"></a>AbstractAdvisorAutoProxyCreator#findEligibleAdvisors</h3><p>对应流程图27</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;Advisor&gt; findEligibleAdvisors(Class&lt;?&gt; beanClass, String beanName) &#123;</span><br><span class="line">	// 获取所有切面 对应流程图28</span><br><span class="line">	List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors();</span><br><span class="line">	List&lt;Advisor&gt; eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName);</span><br><span class="line">	extendAdvisors(eligibleAdvisors);</span><br><span class="line">	if (!eligibleAdvisors.isEmpty()) &#123;</span><br><span class="line">		eligibleAdvisors = sortAdvisors(eligibleAdvisors);</span><br><span class="line">	&#125;</span><br><span class="line">	return eligibleAdvisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractAdvisorAutoProxyCreator-findCandidateAdvisors"><a href="#AbstractAdvisorAutoProxyCreator-findCandidateAdvisors" class="headerlink" title="AbstractAdvisorAutoProxyCreator#findCandidateAdvisors"></a>AbstractAdvisorAutoProxyCreator#findCandidateAdvisors</h3><p>对应流程图28</p>
<figure class="highlight plaintext"><figcaption><span>List<Advisor> findCandidateAdvisors() &#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	Assert.state(this.advisorRetrievalHelper != null, &quot;No BeanFactoryAdvisorRetrievalHelper available&quot;);</span><br><span class="line">	// 获取切面 对应流程图29</span><br><span class="line">	return this.advisorRetrievalHelper.findAdvisorBeans();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AnnotationAwareAspectJAutoProxyCreator-findCandidateAdvisors-1"><a href="#AnnotationAwareAspectJAutoProxyCreator-findCandidateAdvisors-1" class="headerlink" title="AnnotationAwareAspectJAutoProxyCreator#findCandidateAdvisors"></a>AnnotationAwareAspectJAutoProxyCreator#findCandidateAdvisors</h3><p>对应流程图中的29</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;Advisor&gt; findCandidateAdvisors() &#123;</span><br><span class="line">	</span><br><span class="line">	List&lt;Advisor&gt; advisors = super.findCandidateAdvisors();</span><br><span class="line">	// Build Advisors for all AspectJ aspects in the bean factory.</span><br><span class="line">	if (this.aspectJAdvisorsBuilder != null) &#123;</span><br><span class="line">		// 通过buildAspectJAdvisors方法获取切面 对应流程图30</span><br><span class="line">		advisors.addAll(this.aspectJAdvisorsBuilder.buildAspectJAdvisors());</span><br><span class="line">	&#125;</span><br><span class="line">	return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BeanFactoryAspectJAdvisorsBuilder-buildAspectJAdvisors-1"><a href="#BeanFactoryAspectJAdvisorsBuilder-buildAspectJAdvisors-1" class="headerlink" title="BeanFactoryAspectJAdvisorsBuilder#buildAspectJAdvisors"></a>BeanFactoryAspectJAdvisorsBuilder#buildAspectJAdvisors</h3><p>对应流程图30<br>构造切面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Advisor&gt; buildAspectJAdvisors() &#123;</span><br><span class="line">	List&lt;String&gt; aspectNames = this.aspectBeanNames;</span><br><span class="line">	// aspectNames不为空 因为第一次进来(流程图13)时候已经赋值过了</span><br><span class="line">	if (aspectNames == null) &#123;</span><br><span class="line">		synchronized (this) &#123;</span><br><span class="line">			aspectNames = this.aspectBeanNames;</span><br><span class="line">			if (aspectNames == null) &#123;</span><br><span class="line">				List&lt;Advisor&gt; advisors = new ArrayList&lt;&gt;();</span><br><span class="line">				aspectNames = new ArrayList&lt;&gt;();</span><br><span class="line">				String[] beanNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors(</span><br><span class="line">						this.beanFactory, Object.class, true, false);</span><br><span class="line">				for (String beanName : beanNames) &#123;</span><br><span class="line">					if (!isEligibleBean(beanName)) &#123;</span><br><span class="line">						continue;</span><br><span class="line">					&#125;</span><br><span class="line">					</span><br><span class="line">					Class&lt;?&gt; beanType = this.beanFactory.getType(beanName, false);</span><br><span class="line">					if (beanType == null) &#123;</span><br><span class="line">						continue;</span><br><span class="line">					&#125;</span><br><span class="line">					if (this.advisorFactory.isAspect(beanType)) &#123;</span><br><span class="line">						aspectNames.add(beanName);</span><br><span class="line">						AspectMetadata amd = new AspectMetadata(beanType, beanName);</span><br><span class="line">						if (amd.getAjType().getPerClause().getKind() == PerClauseKind.SINGLETON) &#123;</span><br><span class="line">							MetadataAwareAspectInstanceFactory factory =</span><br><span class="line">									new BeanFactoryAspectInstanceFactory(this.beanFactory, beanName);</span><br><span class="line">							List&lt;Advisor&gt; classAdvisors = this.advisorFactory.getAdvisors(factory);</span><br><span class="line">							if (this.beanFactory.isSingleton(beanName)) &#123;</span><br><span class="line">								this.advisorsCache.put(beanName, classAdvisors);</span><br><span class="line">							&#125;</span><br><span class="line">							else &#123;</span><br><span class="line">								this.aspectFactoryCache.put(beanName, factory);</span><br><span class="line">							&#125;</span><br><span class="line">							advisors.addAll(classAdvisors);</span><br><span class="line">						&#125;</span><br><span class="line">						else &#123;</span><br><span class="line">							// Per target or per this.</span><br><span class="line">							if (this.beanFactory.isSingleton(beanName)) &#123;</span><br><span class="line">								throw new IllegalArgumentException(&quot;Bean with name &#x27;&quot; + beanName +</span><br><span class="line">										&quot;&#x27; is a singleton, but aspect instantiation model is not singleton&quot;);</span><br><span class="line">							&#125;</span><br><span class="line">							MetadataAwareAspectInstanceFactory factory =</span><br><span class="line">									new PrototypeAspectInstanceFactory(this.beanFactory, beanName);</span><br><span class="line">							this.aspectFactoryCache.put(beanName, factory);</span><br><span class="line">							advisors.addAll(this.advisorFactory.getAdvisors(factory));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				this.aspectBeanNames = aspectNames;</span><br><span class="line">				return advisors;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (aspectNames.isEmpty()) &#123;</span><br><span class="line">		return Collections.emptyList();</span><br><span class="line">	&#125;</span><br><span class="line">	List&lt;Advisor&gt; advisors = new ArrayList&lt;&gt;();</span><br><span class="line">	for (String aspectName : aspectNames) &#123;</span><br><span class="line">	    // 从缓存中获取切面</span><br><span class="line">		List&lt;Advisor&gt; cachedAdvisors = this.advisorsCache.get(aspectName);</span><br><span class="line">		if (cachedAdvisors != null) &#123;</span><br><span class="line">			advisors.addAll(cachedAdvisors);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			MetadataAwareAspectInstanceFactory factory = this.aspectFactoryCache.get(aspectName);</span><br><span class="line">			advisors.addAll(this.advisorFactory.getAdvisors(factory));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractAdvisorAutoProxyCreator-findEligibleAdvisors-1"><a href="#AbstractAdvisorAutoProxyCreator-findEligibleAdvisors-1" class="headerlink" title="AbstractAdvisorAutoProxyCreator#findEligibleAdvisors"></a>AbstractAdvisorAutoProxyCreator#findEligibleAdvisors</h3><p>对应流程图31</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;Advisor&gt; findEligibleAdvisors(Class&lt;?&gt; beanClass, String beanName) &#123;</span><br><span class="line">	List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors();</span><br><span class="line">	// 拿到切面以后匹配(自己的业务Service AopService) 对应流程图32</span><br><span class="line">	List&lt;Advisor&gt; eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName);</span><br><span class="line">	extendAdvisors(eligibleAdvisors);</span><br><span class="line">	if (!eligibleAdvisors.isEmpty()) &#123;</span><br><span class="line">		eligibleAdvisors = sortAdvisors(eligibleAdvisors);</span><br><span class="line">	&#125;</span><br><span class="line">	return eligibleAdvisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractAdvisorAutoProxyCreator-findAdvisorsThatCanApply"><a href="#AbstractAdvisorAutoProxyCreator-findAdvisorsThatCanApply" class="headerlink" title="AbstractAdvisorAutoProxyCreator#findAdvisorsThatCanApply"></a>AbstractAdvisorAutoProxyCreator#findAdvisorsThatCanApply</h3><p>对应流程图32<br>业务service匹配切面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;Advisor&gt; findAdvisorsThatCanApply(</span><br><span class="line">		List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; beanClass, String beanName) &#123;</span><br><span class="line"></span><br><span class="line">	ProxyCreationContext.setCurrentProxiedBeanName(beanName);</span><br><span class="line">	try &#123;</span><br><span class="line">		// 业务service匹配切面 对应流程图33</span><br><span class="line">		return AopUtils.findAdvisorsThatCanApply(candidateAdvisors, beanClass);</span><br><span class="line">	&#125;</span><br><span class="line">	finally &#123;</span><br><span class="line">		ProxyCreationContext.setCurrentProxiedBeanName(null);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AopUtils-findAdvisorsThatCanApply"><a href="#AopUtils-findAdvisorsThatCanApply" class="headerlink" title="AopUtils#findAdvisorsThatCanApply"></a>AopUtils#findAdvisorsThatCanApply</h3><p>对应流程图33<br>查询和业务service匹配的切面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public static List&lt;Advisor&gt; findAdvisorsThatCanApply(List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; clazz) &#123;</span><br><span class="line">	if (candidateAdvisors.isEmpty()) &#123;</span><br><span class="line">		return candidateAdvisors;</span><br><span class="line">	&#125;</span><br><span class="line">	List&lt;Advisor&gt; eligibleAdvisors = new ArrayList&lt;&gt;();</span><br><span class="line">	for (Advisor candidate : candidateAdvisors) &#123;</span><br><span class="line">		if (candidate instanceof IntroductionAdvisor &amp;&amp; canApply(candidate, clazz)) &#123;</span><br><span class="line">			eligibleAdvisors.add(candidate);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	boolean hasIntroductions = !eligibleAdvisors.isEmpty();</span><br><span class="line">	for (Advisor candidate : candidateAdvisors) &#123;</span><br><span class="line">		if (candidate instanceof IntroductionAdvisor) &#123;</span><br><span class="line">			// already processed</span><br><span class="line">			continue;</span><br><span class="line">		&#125;</span><br><span class="line">		// 判断业务service bean是否匹配切面 对应流程图34</span><br><span class="line">		if (canApply(candidate, clazz, hasIntroductions)) &#123;</span><br><span class="line">			eligibleAdvisors.add(candidate);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return eligibleAdvisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AopUtils-canApply"><a href="#AopUtils-canApply" class="headerlink" title="AopUtils#canApply"></a>AopUtils#canApply</h3><p>对应流程图34</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public static boolean canApply(Advisor advisor, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123;</span><br><span class="line">	if (advisor instanceof IntroductionAdvisor) &#123;</span><br><span class="line">		return ((IntroductionAdvisor) advisor).getClassFilter().matches(targetClass);</span><br><span class="line">	&#125;</span><br><span class="line">	else if (advisor instanceof PointcutAdvisor) &#123;</span><br><span class="line">		PointcutAdvisor pca = (PointcutAdvisor) advisor;</span><br><span class="line">		// 拿到切点 然后匹配service bean 对应流程图35</span><br><span class="line">		return canApply(pca.getPointcut(), targetClass, hasIntroductions);</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		// It doesn&#x27;t have a pointcut so we assume it applies.</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AopUtils-canApply-Pointcut-pc-Class-lt-gt-targetClass-boolean-hasIntroductions"><a href="#AopUtils-canApply-Pointcut-pc-Class-lt-gt-targetClass-boolean-hasIntroductions" class="headerlink" title="AopUtils#canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions)"></a>AopUtils#canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions)</h3><p>对应流程图35</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public static boolean canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123;</span><br><span class="line">	Assert.notNull(pc, &quot;Pointcut must not be null&quot;);</span><br><span class="line">	if (!pc.getClassFilter().matches(targetClass)) &#123;</span><br><span class="line">		return false;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MethodMatcher methodMatcher = pc.getMethodMatcher();</span><br><span class="line">	if (methodMatcher == MethodMatcher.TRUE) &#123;</span><br><span class="line">		// No need to iterate the methods if we&#x27;re matching any method anyway...</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	IntroductionAwareMethodMatcher introductionAwareMethodMatcher = null;</span><br><span class="line">	if (methodMatcher instanceof IntroductionAwareMethodMatcher) &#123;</span><br><span class="line">		introductionAwareMethodMatcher = (IntroductionAwareMethodMatcher) methodMatcher;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Set&lt;Class&lt;?&gt;&gt; classes = new LinkedHashSet&lt;&gt;();</span><br><span class="line">	if (!Proxy.isProxyClass(targetClass)) &#123;</span><br><span class="line">		classes.add(ClassUtils.getUserClass(targetClass));</span><br><span class="line">	&#125;</span><br><span class="line">	classes.addAll(ClassUtils.getAllInterfacesForClassAsSet(targetClass));</span><br><span class="line"></span><br><span class="line">	for (Class&lt;?&gt; clazz : classes) &#123;</span><br><span class="line">		// 拿到业务service bean的所有方法</span><br><span class="line">		Method[] methods = ReflectionUtils.getAllDeclaredMethods(clazz);</span><br><span class="line">		for (Method method : methods) &#123;</span><br><span class="line">			// 遍历方法来匹配切面 有一个匹配上就返回true</span><br><span class="line">			if (introductionAwareMethodMatcher != null ?</span><br><span class="line">					introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions) :</span><br><span class="line">					methodMatcher.matches(method, targetClass)) &#123;</span><br><span class="line">				return true;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拿到service bean方法匹配的切面后 回到AbstractAutoProxyCreator#wrapIfNecessary方法继续往下执行准备创建代理</p>
<h3 id="AbstractAutoProxyCreator-wrapIfNecessary-1"><a href="#AbstractAutoProxyCreator-wrapIfNecessary-1" class="headerlink" title="AbstractAutoProxyCreator#wrapIfNecessary"></a>AbstractAutoProxyCreator#wrapIfNecessary</h3><p>对应流程图36</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123;</span><br><span class="line">	if (StringUtils.hasLength(beanName) &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">		return bean;</span><br><span class="line">	&#125;</span><br><span class="line">	if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line">		return bean;</span><br><span class="line">	&#125;</span><br><span class="line">	if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line">		this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">		return bean;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Create proxy if we have advice.</span><br><span class="line">	Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);</span><br><span class="line">	if (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line">		this.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line">		// 创建代理 对应流程图37</span><br><span class="line">		Object proxy = createProxy(</span><br><span class="line">				bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));</span><br><span class="line">		this.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">		return proxy;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">	return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractAutoProxyCreator-createProxy"><a href="#AbstractAutoProxyCreator-createProxy" class="headerlink" title="AbstractAutoProxyCreator#createProxy"></a>AbstractAutoProxyCreator#createProxy</h3><p>对应流程图37<br>创建代理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">protected Object createProxy(Class&lt;?&gt; beanClass, @Nullable String beanName,</span><br><span class="line">		@Nullable Object[] specificInterceptors, TargetSource targetSource) &#123;</span><br><span class="line"></span><br><span class="line">	if (this.beanFactory instanceof ConfigurableListableBeanFactory) &#123;</span><br><span class="line">		AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory) this.beanFactory, beanName, beanClass);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ProxyFactory proxyFactory = new ProxyFactory();</span><br><span class="line">	proxyFactory.copyFrom(this);</span><br><span class="line">	// 判断是否直接代理目标类或接口。</span><br><span class="line">	if (proxyFactory.isProxyTargetClass()) &#123;</span><br><span class="line">		// 判断beanClass是不是动态代理生成的类或者lambda引用的类 显然都不是</span><br><span class="line">		if (Proxy.isProxyClass(beanClass) || ClassUtils.isLambdaClass(beanClass)) &#123;</span><br><span class="line">			// Must allow for introductions; can&#x27;t just set interfaces to the proxy&#x27;s interfaces only.</span><br><span class="line">			for (Class&lt;?&gt; ifc : beanClass.getInterfaces()) &#123;</span><br><span class="line">				proxyFactory.addInterface(ifc);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		// No proxyTargetClass flag enforced, let&#x27;s apply our default checks...</span><br><span class="line">		if (shouldProxyTargetClass(beanClass, beanName)) &#123;</span><br><span class="line">			proxyFactory.setProxyTargetClass(true);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			evaluateProxyInterfaces(beanClass, proxyFactory);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);</span><br><span class="line">	proxyFactory.addAdvisors(advisors);</span><br><span class="line">	proxyFactory.setTargetSource(targetSource);</span><br><span class="line">	customizeProxyFactory(proxyFactory);</span><br><span class="line"></span><br><span class="line">	proxyFactory.setFrozen(this.freezeProxy);</span><br><span class="line">	if (advisorsPreFiltered()) &#123;</span><br><span class="line">		proxyFactory.setPreFiltered(true);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Use original ClassLoader if bean class not locally loaded in overriding class loader</span><br><span class="line">	ClassLoader classLoader = getProxyClassLoader();</span><br><span class="line">	if (classLoader instanceof SmartClassLoader &amp;&amp; classLoader != beanClass.getClassLoader()) &#123;</span><br><span class="line">		classLoader = ((SmartClassLoader) classLoader).getOriginalClassLoader();</span><br><span class="line">	&#125;</span><br><span class="line">	// 代理工厂创建代理 对应流程图38</span><br><span class="line">	return proxyFactory.getProxy(classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ProxyFactory-getProxy"><a href="#ProxyFactory-getProxy" class="headerlink" title="ProxyFactory#getProxy"></a>ProxyFactory#getProxy</h3><p>对应流程图38</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public Object getProxy(@Nullable ClassLoader classLoader) &#123;</span><br><span class="line">	// 创建aop代理 对应流程图39</span><br><span class="line">	return createAopProxy().getProxy(classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ProxyCreatorSupport-createAopProxy"><a href="#ProxyCreatorSupport-createAopProxy" class="headerlink" title="ProxyCreatorSupport#createAopProxy"></a>ProxyCreatorSupport#createAopProxy</h3><p>对应流程图39</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">protected final synchronized AopProxy createAopProxy() &#123;</span><br><span class="line">	if (!this.active) &#123;</span><br><span class="line">		activate();</span><br><span class="line">	&#125;</span><br><span class="line">	// 创建代理 对应流程图40</span><br><span class="line">	return getAopProxyFactory().createAopProxy(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DefaultAopProxyFactory-createAopProxy"><a href="#DefaultAopProxyFactory-createAopProxy" class="headerlink" title="DefaultAopProxyFactory#createAopProxy"></a>DefaultAopProxyFactory#createAopProxy</h3><p>对应流程图40</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException &#123;</span><br><span class="line">	if (!NativeDetector.inNativeImage() &amp;&amp;</span><br><span class="line">			(config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config))) &#123;</span><br><span class="line">		Class&lt;?&gt; targetClass = config.getTargetClass();</span><br><span class="line">		if (targetClass == null) &#123;</span><br><span class="line">			throw new AopConfigException(&quot;TargetSource cannot determine target class: &quot; +</span><br><span class="line">					&quot;Either an interface or a target is required for proxy creation.&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		if (targetClass.isInterface() || Proxy.isProxyClass(targetClass) || ClassUtils.isLambdaClass(targetClass)) &#123;</span><br><span class="line">			return new JdkDynamicAopProxy(config);</span><br><span class="line">		&#125;</span><br><span class="line">		// 创建cglib代理 对应流程图41 42</span><br><span class="line">		return new ObjenesisCglibAopProxy(config);</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		return new JdkDynamicAopProxy(config);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CglibAopProxy构造方法"><a href="#CglibAopProxy构造方法" class="headerlink" title="CglibAopProxy构造方法"></a>CglibAopProxy构造方法</h3><p>对应流程图42</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public CglibAopProxy(AdvisedSupport config) throws AopConfigException &#123;</span><br><span class="line">	Assert.notNull(config, &quot;AdvisedSupport must not be null&quot;);</span><br><span class="line">	if (config.getAdvisorCount() == 0 &amp;&amp; config.getTargetSource() == AdvisedSupport.EMPTY_TARGET_SOURCE) &#123;</span><br><span class="line">		throw new AopConfigException(&quot;No advisors and no TargetSource specified&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	this.advised = config;</span><br><span class="line">	this.advisedDispatcher = new AdvisedDispatcher(this.advised);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="小总结-1"><a href="#小总结-1" class="headerlink" title="小总结"></a>小总结</h3><p>流程图24~42 对应的是从缓存中获取之前缓存的切面信息，匹配将要被代理对象的方法，得到匹配上的切面方法的拦截器列表ExposeInvocationInterceptor、MethodBeforeAdviceInterceptor、AfterRunningAdviceInterceptor，然后把拦截器列表传递到创建代理方法中，创建代理，默认是cglib代理，这一部分的入口是postProcessAfterInitialization 在bean初始化后完成的</p>
<p>代理对象创建完毕之后接下来进入执行切面方法和业务方法，首先会被拦截</p>
<h3 id="DynamicAdvisedInterceptor-intercept"><a href="#DynamicAdvisedInterceptor-intercept" class="headerlink" title="DynamicAdvisedInterceptor#intercept"></a>DynamicAdvisedInterceptor#intercept</h3><p>对应流程图43</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public Object intercept(Object proxy, Method method, Object[] args, MethodProxy methodProxy) throws Throwable &#123;</span><br><span class="line">	Object oldProxy = null;</span><br><span class="line">	boolean setProxyContext = false;</span><br><span class="line">	Object target = null;</span><br><span class="line">	TargetSource targetSource = this.advised.getTargetSource();</span><br><span class="line">	try &#123;</span><br><span class="line">		if (this.advised.exposeProxy) &#123;				</span><br><span class="line">			//使当前给定的代理可用，获取旧值(之前的代理)</span><br><span class="line">			oldProxy = AopContext.setCurrentProxy(proxy);</span><br><span class="line">			setProxyContext = true;</span><br><span class="line">		&#125;</span><br><span class="line">		// Get as late as possible to minimize the time we &quot;own&quot; the target, in case it comes from a pool...</span><br><span class="line">		target = targetSource.getTarget();</span><br><span class="line">		Class&lt;?&gt; targetClass = (target != null ? target.getClass() : null);</span><br><span class="line">		//根据配置获取给定方法的 org.aopalliance.intercept.MethodInterceptor对象列表，也就是这个方法需要经过的拦截器。</span><br><span class="line">		//这里有三个 ExposeInvocationInterceptor、MethodBeforeAdviceInterceptor、AfterRunningAdviceInterceptor</span><br><span class="line">		List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line">		Object retVal;			</span><br><span class="line">		if (chain.isEmpty() &amp;&amp; CglibMethodInvocation.isMethodProxyCompatible(method)) &#123;			</span><br><span class="line">			Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);</span><br><span class="line">			retVal = invokeMethod(target, method, argsToUse, methodProxy);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			// 创建cglib方法调用进行处理 对应流程图中的44  特别注意这里的有构造方法CglibMethodInvocation中传递了chain</span><br><span class="line">			retVal = new CglibMethodInvocation(proxy, target, method, args, targetClass, chain, methodProxy).proceed();</span><br><span class="line">		&#125;</span><br><span class="line">		retVal = processReturnType(proxy, target, method, retVal);</span><br><span class="line">		return retVal;</span><br><span class="line">	&#125;</span><br><span class="line">	finally &#123;</span><br><span class="line">		if (target != null &amp;&amp; !targetSource.isStatic()) &#123;</span><br><span class="line">			targetSource.releaseTarget(target);</span><br><span class="line">		&#125;</span><br><span class="line">		if (setProxyContext) &#123;</span><br><span class="line">			// Restore old proxy.</span><br><span class="line">			AopContext.setCurrentProxy(oldProxy);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CglibAopProxy-CglibMethodInvocation-proceed"><a href="#CglibAopProxy-CglibMethodInvocation-proceed" class="headerlink" title="CglibAopProxy.CglibMethodInvocation#proceed"></a>CglibAopProxy.CglibMethodInvocation#proceed</h3><p>对应流程图44</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public Object proceed() throws Throwable &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				// 调用父类的方法 对应流程图45</span><br><span class="line">				return super.proceed();</span><br><span class="line">			&#125;</span><br><span class="line">			catch (RuntimeException ex) &#123;</span><br><span class="line">				throw ex;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Exception ex) &#123;</span><br><span class="line">				if (ReflectionUtils.declaresException(getMethod(), ex.getClass()) ||</span><br><span class="line">						KotlinDetector.isKotlinType(getMethod().getDeclaringClass())) &#123;</span><br><span class="line">					//···</span><br><span class="line">				&#125;</span><br><span class="line">				else &#123;</span><br><span class="line">					//···</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ReflectiveMethodInvocation-proceed"><a href="#ReflectiveMethodInvocation-proceed" class="headerlink" title="ReflectiveMethodInvocation#proceed"></a>ReflectiveMethodInvocation#proceed</h3><p>对应流程图45</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public Object proceed() throws Throwable &#123;</span><br><span class="line">	// currentInterceptorIndex是从-1 开始 拦截器链interceptorsAndDynamicMethodMatchers就是之前匹配到的切面拦截器</span><br><span class="line">	//ExposeInvocationInterceptor、MethodBeforeAdviceInterceptor、AfterRunningAdviceInterceptor</span><br><span class="line">	if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1) &#123;</span><br><span class="line">		return invokeJoinpoint();</span><br><span class="line">	&#125;</span><br><span class="line">	// 拦截器索引先加1 再获取具体的拦截器 get(0) 就是ExposeInvocationInterceptor</span><br><span class="line">	Object interceptorOrInterceptionAdvice =</span><br><span class="line">			this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex);</span><br><span class="line">	if (interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher) &#123;</span><br><span class="line">		// Evaluate dynamic method matcher here: static part will already have</span><br><span class="line">		// been evaluated and found to match.</span><br><span class="line">		InterceptorAndDynamicMethodMatcher dm =</span><br><span class="line">				(InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;</span><br><span class="line">		Class&lt;?&gt; targetClass = (this.targetClass != null ? this.targetClass : this.method.getDeclaringClass());</span><br><span class="line">		if (dm.methodMatcher.matches(this.method, targetClass, this.arguments)) &#123;</span><br><span class="line">			return dm.interceptor.invoke(this);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			// Dynamic matching failed.</span><br><span class="line">			// Skip this interceptor and invoke the next in the chain.</span><br><span class="line">			return proceed();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		//调用获取到的拦截器的invoke方法 对应流程图46</span><br><span class="line">		// ExposeInvocationInterceptor#invoke</span><br><span class="line">		return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ExposeInvocationInterceptor-invoke"><a href="#ExposeInvocationInterceptor-invoke" class="headerlink" title="ExposeInvocationInterceptor#invoke"></a>ExposeInvocationInterceptor#invoke</h3><p>对应流程图46</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public Object invoke(MethodInvocation mi) throws Throwable &#123;</span><br><span class="line">	MethodInvocation oldInvocation = invocation.get();</span><br><span class="line">	invocation.set(mi);</span><br><span class="line">	try &#123;</span><br><span class="line">		// 进入递归调用 对应流程图47</span><br><span class="line">		return mi.proceed();</span><br><span class="line">	&#125;</span><br><span class="line">	finally &#123;</span><br><span class="line">		invocation.set(oldInvocation);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CglibAopProxy-CglibMethodInvocation-proceed-1"><a href="#CglibAopProxy-CglibMethodInvocation-proceed-1" class="headerlink" title="CglibAopProxy.CglibMethodInvocation#proceed"></a>CglibAopProxy.CglibMethodInvocation#proceed</h3><p>对应流程图47</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public Object proceed() throws Throwable &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				// 调用父类的方法 对应流程图48</span><br><span class="line">				return super.proceed();</span><br><span class="line">			&#125;</span><br><span class="line">			catch (RuntimeException ex) &#123;</span><br><span class="line">				throw ex;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Exception ex) &#123;</span><br><span class="line">				if (ReflectionUtils.declaresException(getMethod(), ex.getClass()) ||</span><br><span class="line">						KotlinDetector.isKotlinType(getMethod().getDeclaringClass())) &#123;</span><br><span class="line">					//···</span><br><span class="line">				&#125;</span><br><span class="line">				else &#123;</span><br><span class="line">					//···</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ReflectiveMethodInvocation-proceed-1"><a href="#ReflectiveMethodInvocation-proceed-1" class="headerlink" title="ReflectiveMethodInvocation#proceed"></a>ReflectiveMethodInvocation#proceed</h3><p>对应流程图48</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public Object proceed() throws Throwable &#123;</span><br><span class="line">	// currentInterceptorIndex已经变成0,拦截器链		//ExposeInvocationInterceptor、MethodBeforeAdviceInterceptor、AfterRunningAdviceInterceptor</span><br><span class="line">	if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1) &#123;</span><br><span class="line">		return invokeJoinpoint();</span><br><span class="line">	&#125;</span><br><span class="line">	// 拦截器索引先加1 再获取具体的拦截器 get(1) 就是MethodBeforeAdviceInterceptor</span><br><span class="line">	Object interceptorOrInterceptionAdvice =</span><br><span class="line">			this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex);</span><br><span class="line">	if (interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher) &#123;</span><br><span class="line">		// Evaluate dynamic method matcher here: static part will already have</span><br><span class="line">		// been evaluated and found to match.</span><br><span class="line">		InterceptorAndDynamicMethodMatcher dm =</span><br><span class="line">				(InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;</span><br><span class="line">		Class&lt;?&gt; targetClass = (this.targetClass != null ? this.targetClass : this.method.getDeclaringClass());</span><br><span class="line">		if (dm.methodMatcher.matches(this.method, targetClass, this.arguments)) &#123;</span><br><span class="line">			return dm.interceptor.invoke(this);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			// Dynamic matching failed.</span><br><span class="line">			// Skip this interceptor and invoke the next in the chain.</span><br><span class="line">			return proceed();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		//调用获取到的拦截器的invoke方法 对应流程图49</span><br><span class="line">		// MethodBeforeAdviceInterceptor#invoke</span><br><span class="line">		return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MethodBeforeAdviceInterceptor-invoke"><a href="#MethodBeforeAdviceInterceptor-invoke" class="headerlink" title="MethodBeforeAdviceInterceptor#invoke"></a>MethodBeforeAdviceInterceptor#invoke</h3><p>对应流程图49</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public Object invoke(MethodInvocation mi) throws Throwable &#123;</span><br><span class="line">	// 执行@Before方法的逻辑 对应流程图49-1 ~ 49-5</span><br><span class="line">	this.advice.before(mi.getMethod(), mi.getArguments(), mi.getThis());</span><br><span class="line">	// 对应流程图50</span><br><span class="line">	return mi.proceed();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CglibAopProxy-CglibMethodInvocation-proceed-2"><a href="#CglibAopProxy-CglibMethodInvocation-proceed-2" class="headerlink" title="CglibAopProxy.CglibMethodInvocation#proceed"></a>CglibAopProxy.CglibMethodInvocation#proceed</h3><p>对应流程图50</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public Object proceed() throws Throwable &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				// 调用父类的方法 对应流程图51</span><br><span class="line">				return super.proceed();</span><br><span class="line">			&#125;</span><br><span class="line">			catch (RuntimeException ex) &#123;</span><br><span class="line">				throw ex;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Exception ex) &#123;</span><br><span class="line">				if (ReflectionUtils.declaresException(getMethod(), ex.getClass()) ||</span><br><span class="line">						KotlinDetector.isKotlinType(getMethod().getDeclaringClass())) &#123;</span><br><span class="line">					//···</span><br><span class="line">				&#125;</span><br><span class="line">				else &#123;</span><br><span class="line">					//···</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ReflectiveMethodInvocation-proceed-2"><a href="#ReflectiveMethodInvocation-proceed-2" class="headerlink" title="ReflectiveMethodInvocation#proceed"></a>ReflectiveMethodInvocation#proceed</h3><p>对应流程图51</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public Object proceed() throws Throwable &#123;</span><br><span class="line">	// currentInterceptorIndex已经变成1,拦截器链		//ExposeInvocationInterceptor、MethodBeforeAdviceInterceptor、AfterRunningAdviceInterceptor</span><br><span class="line">	if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1) &#123;</span><br><span class="line">		return invokeJoinpoint();</span><br><span class="line">	&#125;</span><br><span class="line">	// 拦截器索引先加1 再获取具体的拦截器 get(2) 就是AfterRunningAdviceInterceptor</span><br><span class="line">	Object interceptorOrInterceptionAdvice =</span><br><span class="line">			this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex);</span><br><span class="line">	if (interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher) &#123;</span><br><span class="line">		// Evaluate dynamic method matcher here: static part will already have</span><br><span class="line">		// been evaluated and found to match.</span><br><span class="line">		InterceptorAndDynamicMethodMatcher dm =</span><br><span class="line">				(InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;</span><br><span class="line">		Class&lt;?&gt; targetClass = (this.targetClass != null ? this.targetClass : this.method.getDeclaringClass());</span><br><span class="line">		if (dm.methodMatcher.matches(this.method, targetClass, this.arguments)) &#123;</span><br><span class="line">			return dm.interceptor.invoke(this);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			// Dynamic matching failed.</span><br><span class="line">			// Skip this interceptor and invoke the next in the chain.</span><br><span class="line">			return proceed();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		//调用获取到的拦截器的invoke方法 对应流程图52</span><br><span class="line">		// AfterRunningAdviceInterceptor#invoke</span><br><span class="line">		return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AfterRunningAdviceInterceptor-invoke"><a href="#AfterRunningAdviceInterceptor-invoke" class="headerlink" title="AfterRunningAdviceInterceptor#invoke"></a>AfterRunningAdviceInterceptor#invoke</h3><p>对应流程图52</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public Object invoke(MethodInvocation mi) throws Throwable &#123;</span><br><span class="line">	// 对应流程图53</span><br><span class="line">	Object retVal = mi.proceed();</span><br><span class="line">	this.advice.afterReturning(retVal, mi.getMethod(), mi.getArguments(), mi.getThis());	</span><br><span class="line">	return retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CglibAopProxy-CglibMethodInvocation-proceed-3"><a href="#CglibAopProxy-CglibMethodInvocation-proceed-3" class="headerlink" title="CglibAopProxy.CglibMethodInvocation#proceed"></a>CglibAopProxy.CglibMethodInvocation#proceed</h3><p>对应流程图53</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public Object proceed() throws Throwable &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				// 调用父类的方法 对应流程图54</span><br><span class="line">				return super.proceed();</span><br><span class="line">			&#125;</span><br><span class="line">			catch (RuntimeException ex) &#123;</span><br><span class="line">				throw ex;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Exception ex) &#123;</span><br><span class="line">				if (ReflectionUtils.declaresException(getMethod(), ex.getClass()) ||</span><br><span class="line">						KotlinDetector.isKotlinType(getMethod().getDeclaringClass())) &#123;</span><br><span class="line">					//···</span><br><span class="line">				&#125;</span><br><span class="line">				else &#123;</span><br><span class="line">					//···</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ReflectiveMethodInvocation-proceed-3"><a href="#ReflectiveMethodInvocation-proceed-3" class="headerlink" title="ReflectiveMethodInvocation#proceed"></a>ReflectiveMethodInvocation#proceed</h3><p>对应流程图54</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public Object proceed() throws Throwable &#123;</span><br><span class="line">	// currentInterceptorIndex已经变成2,拦截器链		//ExposeInvocationInterceptor、MethodBeforeAdviceInterceptor、AfterRunningAdviceInterceptor</span><br><span class="line">	if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1) &#123;</span><br><span class="line">		// 2=2 进入if分支 执行方法 对应流程图55 退出递归</span><br><span class="line">		return invokeJoinpoint();</span><br><span class="line">	&#125;</span><br><span class="line">	// 不走了</span><br><span class="line">	Object interceptorOrInterceptionAdvice =</span><br><span class="line">			this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex);</span><br><span class="line">	if (interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher) &#123;</span><br><span class="line">		// Evaluate dynamic method matcher here: static part will already have</span><br><span class="line">		// been evaluated and found to match.</span><br><span class="line">		InterceptorAndDynamicMethodMatcher dm =</span><br><span class="line">				(InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;</span><br><span class="line">		Class&lt;?&gt; targetClass = (this.targetClass != null ? this.targetClass : this.method.getDeclaringClass());</span><br><span class="line">		if (dm.methodMatcher.matches(this.method, targetClass, this.arguments)) &#123;</span><br><span class="line">			return dm.interceptor.invoke(this);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			// Dynamic matching failed.</span><br><span class="line">			// Skip this interceptor and invoke the next in the chain.</span><br><span class="line">			return proceed();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		</span><br><span class="line">		return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CglibAopProxy-CglibMethodInvocation-invokeJoinpoint"><a href="#CglibAopProxy-CglibMethodInvocation-invokeJoinpoint" class="headerlink" title="CglibAopProxy.CglibMethodInvocation#invokeJoinpoint"></a>CglibAopProxy.CglibMethodInvocation#invokeJoinpoint</h3><p>对应流程图55</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">protected Object invokeJoinpoint() throws Throwable &#123;</span><br><span class="line">	if (this.methodProxy != null) &#123;</span><br><span class="line">		try &#123;</span><br><span class="line">			// 调用代理对象的业务方法 AopService的test方法 对应流程图56-57</span><br><span class="line">			return this.methodProxy.invoke(this.target, this.arguments);</span><br><span class="line">		&#125;</span><br><span class="line">		catch (CodeGenerationException ex) &#123;</span><br><span class="line">			logFastClassGenerationFailure(this.method);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return super.invokeJoinpoint();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后递归依次往回返，先返回到AfterRunningAdviceInterceptor#invoke然后接着往下执行</p>
<h3 id="AfterRunningAdviceInterceptor-invoke-1"><a href="#AfterRunningAdviceInterceptor-invoke-1" class="headerlink" title="AfterRunningAdviceInterceptor#invoke"></a>AfterRunningAdviceInterceptor#invoke</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public Object invoke(MethodInvocation mi) throws Throwable &#123;</span><br><span class="line">	// 返回后在这个位置</span><br><span class="line">	Object retVal = mi.proceed();</span><br><span class="line">	// 执行@AfterReturning方法的逻辑 对应流程图58 ~ 63</span><br><span class="line">	this.advice.afterReturning(retVal, mi.getMethod(), mi.getArguments(), mi.getThis());	</span><br><span class="line">	</span><br><span class="line">	return retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="小总结-2"><a href="#小总结-2" class="headerlink" title="小总结"></a>小总结</h3><p>流程图43~63 对应的是执行过程，具体是拿到aop代理对象，执行具体的业务方法所匹配的切面拦截器，ExposeInvocationInterceptor、MethodBeforeAdviceInterceptor、AfterRunningAdviceInterceptor对应的invoke方法，这里要说明的是这一块的拦截器链执行是通过递归的责任链方式，方法入口是CglibMethodInvocation的proceed()，proceed同时也是递归方法,具体的实现是ReflectiveMethodInvocation#proceed方法，进入方法体后，interceptorsAndDynamicMethodMatchers数组就是代理对象匹配的切面拦截器，循环遍历每一个切面拦截器执行invoke方法，按照需要执行切面逻辑或者递归下一轮直到三种拦截器遍历完成进入ReflectiveMethodInvocation#proceed的第一个if代码块的invokeJoinPoint方法，递归结束，依次退出，未执行的切面拦截器方法继续执行，最后结束返回到方法开始的地方DynamicAdvisedInterceptor的intercept方法，从三个拦截器的名称上也能看出都是继承了MethodInterceptor。然后每次执行invoke() 时，里面都会去执行 CglibMethodInvocation 的 proceed()。</p>
<h2 id="看完以后"><a href="#看完以后" class="headerlink" title="看完以后"></a>看完以后</h2><p>点赞，点赞是免费的，但却能激励我保持创作，还能帮助更多的人看到这篇文章。</p>
<p>留言，有任何问题，都可以在评论区留言，我会尽可能回复。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://xuchao6969.github.io">xuchao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://xuchao6969.github.io/2022/10/03/SpringAop/">https://xuchao6969.github.io/2022/10/03/SpringAop/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://xuchao6969.github.io" target="_blank">xuchaoのblog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring/">spring</a></div><div class="post_share"><div class="social-share" data-image="/img/shaosiming.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/10/02/SpringBeanLifecycle/"><img class="prev-cover" src="/img/zyz1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring bean的生命周期</div></div></a></div><div class="next-post pull-right"><a href="/2022/10/04/SpringTransactionManager/"><img class="next-cover" src="/img/wuxin1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Spring transaction manager</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/10/02/SpringBeanLifecycle/" title="Spring bean的生命周期"><img class="cover" src="/img/zyz1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-02</div><div class="title">Spring bean的生命周期</div></div></a></div><div><a href="/2022/10/01/SpringCircularDependency/" title="Spring Circular Dependency"><img class="cover" src="/img/xiaose6.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-01</div><div class="title">Spring Circular Dependency</div></div></a></div><div><a href="/2023/01/21/SpringCloudAlibabaSeata/" title="SpringCloudAlibaba Seata实现分布式事务"><img class="cover" src="/img/xiaose5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-21</div><div class="title">SpringCloudAlibaba Seata实现分布式事务</div></div></a></div><div><a href="/2022/09/27/SpringIoc/" title="Spring Ioc"><img class="cover" src="/img/lifansong.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-27</div><div class="title">Spring Ioc</div></div></a></div><div><a href="/2022/10/04/SpringTransactionManager/" title="Spring transaction manager"><img class="cover" src="/img/wuxin1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-04</div><div class="title">Spring transaction manager</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/leiwujie1.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">xuchao</div><div class="author-info__description">记录一下工作学习生活上的分享~~~ </div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xuchao6969"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xuchao6969" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:xucha_o@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-AOP"><span class="toc-number">1.</span> <span class="toc-text">Spring AOP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFaop"><span class="toc-number">2.</span> <span class="toc-text">什么是aop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring%E6%A1%86%E6%9E%B6%E5%AF%B9Aop%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">Spring框架对Aop的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AOP%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">4.</span> <span class="toc-text">AOP的概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A2%9E%E5%BC%BA%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.</span> <span class="toc-text">增强类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">6.</span> <span class="toc-text">调用流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spring%E7%9A%84%E7%89%88%E6%9C%AC%E6%98%AF5-3-23"><span class="toc-number">7.</span> <span class="toc-text">spring的版本是5.3.23</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">8.</span> <span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringApplication-run-SpringTransactionApplication-class-args"><span class="toc-number">8.1.</span> <span class="toc-text">SpringApplication.run(SpringTransactionApplication.class, args);</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractApplicationContext-refresh"><span class="toc-number">8.2.</span> <span class="toc-text">AbstractApplicationContext#refresh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractAutoProxyCreator-postProcessBeforeInstantiation"><span class="toc-number">8.3.</span> <span class="toc-text">AbstractAutoProxyCreator#postProcessBeforeInstantiation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AspectJAwareAdvisorAutoProxyCreator-shouldSkip"><span class="toc-number">8.4.</span> <span class="toc-text">AspectJAwareAdvisorAutoProxyCreator#shouldSkip</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AnnotationAwareAspectJAutoProxyCreator-findCandidateAdvisors"><span class="toc-number">8.5.</span> <span class="toc-text">AnnotationAwareAspectJAutoProxyCreator#findCandidateAdvisors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BeanFactoryAspectJAdvisorsBuilder-buildAspectJAdvisors"><span class="toc-number">8.6.</span> <span class="toc-text">BeanFactoryAspectJAdvisorsBuilder#buildAspectJAdvisors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractAspectJAdvisorFactory-isAspect"><span class="toc-number">8.7.</span> <span class="toc-text">AbstractAspectJAdvisorFactory#isAspect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReflectiveAspectJAdvisorFactory-getAdvisors"><span class="toc-number">8.8.</span> <span class="toc-text">ReflectiveAspectJAdvisorFactory#getAdvisors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReflectiveAspectJAdvisorFactory-getAdvisor"><span class="toc-number">8.9.</span> <span class="toc-text">ReflectiveAspectJAdvisorFactory#getAdvisor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InstantiationModelAwarePointcutAdvisorImpl%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">8.10.</span> <span class="toc-text">InstantiationModelAwarePointcutAdvisorImpl构造方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InstantiationModelAwarePointcutAdvisorImpl-instantiateAdvice"><span class="toc-number">8.11.</span> <span class="toc-text">InstantiationModelAwarePointcutAdvisorImpl#instantiateAdvice</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReflectiveAspectJAdvisorFactory-getAdvice"><span class="toc-number">8.12.</span> <span class="toc-text">ReflectiveAspectJAdvisorFactory#getAdvice</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E6%80%BB%E7%BB%93"><span class="toc-number">8.13.</span> <span class="toc-text">小总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractAutoProxyCreator-postProcessAfterInitialization"><span class="toc-number">8.14.</span> <span class="toc-text">AbstractAutoProxyCreator#postProcessAfterInitialization</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractAutoProxyCreator-wrapIfNecessary"><span class="toc-number">8.15.</span> <span class="toc-text">AbstractAutoProxyCreator#wrapIfNecessary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractAdvisorAutoProxyCreator-getAdvicesAndAdvisorsForBean"><span class="toc-number">8.16.</span> <span class="toc-text">AbstractAdvisorAutoProxyCreator#getAdvicesAndAdvisorsForBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractAdvisorAutoProxyCreator-findEligibleAdvisors"><span class="toc-number">8.17.</span> <span class="toc-text">AbstractAdvisorAutoProxyCreator#findEligibleAdvisors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractAdvisorAutoProxyCreator-findCandidateAdvisors"><span class="toc-number">8.18.</span> <span class="toc-text">AbstractAdvisorAutoProxyCreator#findCandidateAdvisors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AnnotationAwareAspectJAutoProxyCreator-findCandidateAdvisors-1"><span class="toc-number">8.19.</span> <span class="toc-text">AnnotationAwareAspectJAutoProxyCreator#findCandidateAdvisors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BeanFactoryAspectJAdvisorsBuilder-buildAspectJAdvisors-1"><span class="toc-number">8.20.</span> <span class="toc-text">BeanFactoryAspectJAdvisorsBuilder#buildAspectJAdvisors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractAdvisorAutoProxyCreator-findEligibleAdvisors-1"><span class="toc-number">8.21.</span> <span class="toc-text">AbstractAdvisorAutoProxyCreator#findEligibleAdvisors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractAdvisorAutoProxyCreator-findAdvisorsThatCanApply"><span class="toc-number">8.22.</span> <span class="toc-text">AbstractAdvisorAutoProxyCreator#findAdvisorsThatCanApply</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AopUtils-findAdvisorsThatCanApply"><span class="toc-number">8.23.</span> <span class="toc-text">AopUtils#findAdvisorsThatCanApply</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AopUtils-canApply"><span class="toc-number">8.24.</span> <span class="toc-text">AopUtils#canApply</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AopUtils-canApply-Pointcut-pc-Class-lt-gt-targetClass-boolean-hasIntroductions"><span class="toc-number">8.25.</span> <span class="toc-text">AopUtils#canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractAutoProxyCreator-wrapIfNecessary-1"><span class="toc-number">8.26.</span> <span class="toc-text">AbstractAutoProxyCreator#wrapIfNecessary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractAutoProxyCreator-createProxy"><span class="toc-number">8.27.</span> <span class="toc-text">AbstractAutoProxyCreator#createProxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProxyFactory-getProxy"><span class="toc-number">8.28.</span> <span class="toc-text">ProxyFactory#getProxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProxyCreatorSupport-createAopProxy"><span class="toc-number">8.29.</span> <span class="toc-text">ProxyCreatorSupport#createAopProxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultAopProxyFactory-createAopProxy"><span class="toc-number">8.30.</span> <span class="toc-text">DefaultAopProxyFactory#createAopProxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CglibAopProxy%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">8.31.</span> <span class="toc-text">CglibAopProxy构造方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E6%80%BB%E7%BB%93-1"><span class="toc-number">8.32.</span> <span class="toc-text">小总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DynamicAdvisedInterceptor-intercept"><span class="toc-number">8.33.</span> <span class="toc-text">DynamicAdvisedInterceptor#intercept</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CglibAopProxy-CglibMethodInvocation-proceed"><span class="toc-number">8.34.</span> <span class="toc-text">CglibAopProxy.CglibMethodInvocation#proceed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReflectiveMethodInvocation-proceed"><span class="toc-number">8.35.</span> <span class="toc-text">ReflectiveMethodInvocation#proceed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ExposeInvocationInterceptor-invoke"><span class="toc-number">8.36.</span> <span class="toc-text">ExposeInvocationInterceptor#invoke</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CglibAopProxy-CglibMethodInvocation-proceed-1"><span class="toc-number">8.37.</span> <span class="toc-text">CglibAopProxy.CglibMethodInvocation#proceed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReflectiveMethodInvocation-proceed-1"><span class="toc-number">8.38.</span> <span class="toc-text">ReflectiveMethodInvocation#proceed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MethodBeforeAdviceInterceptor-invoke"><span class="toc-number">8.39.</span> <span class="toc-text">MethodBeforeAdviceInterceptor#invoke</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CglibAopProxy-CglibMethodInvocation-proceed-2"><span class="toc-number">8.40.</span> <span class="toc-text">CglibAopProxy.CglibMethodInvocation#proceed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReflectiveMethodInvocation-proceed-2"><span class="toc-number">8.41.</span> <span class="toc-text">ReflectiveMethodInvocation#proceed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AfterRunningAdviceInterceptor-invoke"><span class="toc-number">8.42.</span> <span class="toc-text">AfterRunningAdviceInterceptor#invoke</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CglibAopProxy-CglibMethodInvocation-proceed-3"><span class="toc-number">8.43.</span> <span class="toc-text">CglibAopProxy.CglibMethodInvocation#proceed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReflectiveMethodInvocation-proceed-3"><span class="toc-number">8.44.</span> <span class="toc-text">ReflectiveMethodInvocation#proceed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CglibAopProxy-CglibMethodInvocation-invokeJoinpoint"><span class="toc-number">8.45.</span> <span class="toc-text">CglibAopProxy.CglibMethodInvocation#invokeJoinpoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AfterRunningAdviceInterceptor-invoke-1"><span class="toc-number">8.46.</span> <span class="toc-text">AfterRunningAdviceInterceptor#invoke</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E6%80%BB%E7%BB%93-2"><span class="toc-number">8.47.</span> <span class="toc-text">小总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9C%8B%E5%AE%8C%E4%BB%A5%E5%90%8E"><span class="toc-number">9.</span> <span class="toc-text">看完以后</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/03/17/BurnTheRope/" title="一根不均匀的绳子，全部烧完需要1个小时，问怎样烧能计时1个小时15分钟"><img src="/img/yuhan1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一根不均匀的绳子，全部烧完需要1个小时，问怎样烧能计时1个小时15分钟"/></a><div class="content"><a class="title" href="/2023/03/17/BurnTheRope/" title="一根不均匀的绳子，全部烧完需要1个小时，问怎样烧能计时1个小时15分钟">一根不均匀的绳子，全部烧完需要1个小时，问怎样烧能计时1个小时15分钟</a><time datetime="2023-03-17T08:30:21.000Z" title="发表于 2023-03-17 16:30:21">2023-03-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/16/NucleicAcidDetection/" title="核酸检测混检为什么采用1管10个样本进行检查"><img src="/img/lihanyi.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="核酸检测混检为什么采用1管10个样本进行检查"/></a><div class="content"><a class="title" href="/2023/03/16/NucleicAcidDetection/" title="核酸检测混检为什么采用1管10个样本进行检查">核酸检测混检为什么采用1管10个样本进行检查</a><time datetime="2023-03-16T10:20:51.000Z" title="发表于 2023-03-16 18:20:51">2023-03-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/21/SpringCloudAlibabaSeata/" title="SpringCloudAlibaba Seata实现分布式事务"><img src="/img/xiaose5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringCloudAlibaba Seata实现分布式事务"/></a><div class="content"><a class="title" href="/2023/01/21/SpringCloudAlibabaSeata/" title="SpringCloudAlibaba Seata实现分布式事务">SpringCloudAlibaba Seata实现分布式事务</a><time datetime="2023-01-21T10:11:51.000Z" title="发表于 2023-01-21 18:11:51">2023-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/21/HexoConfigGiscus/" title="Hexo+Butterfly配置Giscus评论"><img src="/img/leiwujie.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hexo+Butterfly配置Giscus评论"/></a><div class="content"><a class="title" href="/2022/11/21/HexoConfigGiscus/" title="Hexo+Butterfly配置Giscus评论">Hexo+Butterfly配置Giscus评论</a><time datetime="2022-11-21T09:09:25.000Z" title="发表于 2022-11-21 17:09:25">2022-11-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/21/HexoBlogBackup/" title="Hexo 博客备份"><img src="/img/leiwujie1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hexo 博客备份"/></a><div class="content"><a class="title" href="/2022/11/21/HexoBlogBackup/" title="Hexo 博客备份">Hexo 博客备份</a><time datetime="2022-11-21T09:09:25.000Z" title="发表于 2022-11-21 17:09:25">2022-11-21</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/shaosiming.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023  <i id="heartbeat" class="fa fas fa-heartbeat"></i> xuchao</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadGiscus () {
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'xuchao6969/blog_giscus',
    'data-repo-id': 'R_kgDOIMjKeA',
    'data-category-id': 'DIC_kwDOIMjKeM4CR7sR',
    'data-mapping': 'pathname',
    'data-theme': nowTheme,
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme () {
  const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }

  sendMessage({
    setConfig: {
      theme: theme
    }
  });
}

if ('Giscus' === 'Giscus' || !false) {
  if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script async src="https://npm.elemecdn.com/tzy-blog/lib/js/other/sakura.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["link[rel=\"canonical\"]","meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script></div></body></html>