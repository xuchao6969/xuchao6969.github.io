<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Spring Circular Dependency | xuchaoのblog</title><meta name="keywords" content="spring"><meta name="author" content="xuchao"><meta name="copyright" content="xuchao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Spring Circular Dependency循环依赖什么是循环依赖 ServiceA 注入自身 ServiceA注入ServiceB，ServiceB注入ServiceA ServiceA注入ServiceB，ServiceB注入ServiceC，ServiceC注入ServiceA等套娃式的  循环依赖的条件 依赖的bean必须是单例的，非单例的不支持循环依赖 必须通过@Autowire">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Circular Dependency">
<meta property="og:url" content="https://xuchao6969.github.io/2022/10/01/SpringCircularDependency/index.html">
<meta property="og:site_name" content="xuchaoのblog">
<meta property="og:description" content="Spring Circular Dependency循环依赖什么是循环依赖 ServiceA 注入自身 ServiceA注入ServiceB，ServiceB注入ServiceA ServiceA注入ServiceB，ServiceB注入ServiceC，ServiceC注入ServiceA等套娃式的  循环依赖的条件 依赖的bean必须是单例的，非单例的不支持循环依赖 必须通过@Autowire">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xuchao6969.github.io/img/xiaose6.jpg">
<meta property="article:published_time" content="2022-10-01T01:12:22.000Z">
<meta property="article:modified_time" content="2023-04-16T13:57:13.725Z">
<meta property="article:author" content="xuchao">
<meta property="article:tag" content="spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xuchao6969.github.io/img/xiaose6.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://xuchao6969.github.io/2022/10/01/SpringCircularDependency/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50000,"languages":{"author":"作者: xuchao","link":"链接: ","source":"来源: xuchaoのblog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring Circular Dependency',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-16 21:57:13'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/leiwujie1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/xiaose6.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">xuchaoのblog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Spring Circular Dependency</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-01T01:12:22.000Z" title="发表于 2022-10-01 09:12:22">2022-10-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-04-16T13:57:13.725Z" title="更新于 2023-04-16 21:57:13">2023-04-16</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>27分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Spring-Circular-Dependency循环依赖"><a href="#Spring-Circular-Dependency循环依赖" class="headerlink" title="Spring Circular Dependency循环依赖"></a>Spring Circular Dependency循环依赖</h1><h2 id="什么是循环依赖"><a href="#什么是循环依赖" class="headerlink" title="什么是循环依赖"></a>什么是循环依赖</h2><ul>
<li>ServiceA 注入自身<img src="/img/SpringCircularDependency/circulardependency1.jpg"/></li>
<li>ServiceA注入ServiceB，ServiceB注入ServiceA<img src="/img/SpringCircularDependency/circulardependency2.jpg"/></li>
<li>ServiceA注入ServiceB，ServiceB注入ServiceC，ServiceC注入ServiceA等套娃式的</li>
</ul>
<h2 id="循环依赖的条件"><a href="#循环依赖的条件" class="headerlink" title="循环依赖的条件"></a>循环依赖的条件</h2><ul>
<li>依赖的bean必须是单例的，非单例的不支持循环依赖</li>
<li>必须通过@Autowired或者@Resource注入<ul>
<li>@Autowired 是通过AutowiredAnnotationBeanPostProcessor处理的</li>
<li>@Resource 是通过CommonAnnotationBeanPostProcessor处理的</li>
</ul>
</li>
</ul>
<h2 id="循环依赖的核心概念"><a href="#循环依赖的核心概念" class="headerlink" title="循环依赖的核心概念"></a>循环依赖的核心概念</h2><ul>
<li>一级缓存：singletonObjects，用于保存 bean 实例(bean已经完成了实例化、属性注入、初始化是一个可以真正使用的bean)；</li>
<li>二级缓存：earlySingletonObjects，用于保存不完整的 bean 实例(一般仅仅是完成了实例化)；</li>
<li>三级缓存：singletonFactories，用于保存 bean 创建工厂，以便后面有机会创建代理对象，短路bean创建流程。 <img src="/img/SpringCircularDependency/circulardependency3.jpg"/></li>
</ul>
<h2 id="调用流程"><a href="#调用流程" class="headerlink" title="调用流程"></a>调用流程</h2><p>这个着实有点长了，从入口到整个流程，以及调用链路都标了出来，小佩服自己一下(图片可以放大查看，不失真)<br><img src="/img/SpringCircularDependency/circulardependency.jpg" width="100px" height= "400px"/></p>
<h2 id="spring的版本是5-3-23"><a href="#spring的版本是5-3-23" class="headerlink" title="spring的版本是5.3.23"></a>spring的版本是5.3.23</h2><p><a target="_blank" rel="noopener" href="https://github.com/xuchao6969/demo/tree/master/spring-circular-dependency">demo地址:</a> </p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>以serviceA的初始化为核心进行流程分析</p>
<h3 id="SpringApplication-run-SpringTransactionApplication-class-args"><a href="#SpringApplication-run-SpringTransactionApplication-class-args" class="headerlink" title="SpringApplication.run(SpringTransactionApplication.class, args);"></a>SpringApplication.run(SpringTransactionApplication.class, args);</h3><p>对应流程图中的1<br>启动springboot程序，会首先进入到SpringApplication#run方法(3层调用才进入)<br>在这个方法中进行ApplicationContext的创建以及刷新，目的是完成项目所需要spring环境配置和其他依赖配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">   //首先看到这个方法的返回值是ConfigurableApplicationContext 很自然就可以想到这个类直接或间接继承了ApplicationContext然后直接或间接继承了BeanFactory</span><br><span class="line">   //拿到BeanFactory 可以做很多事情，获取bean真的是简简单单了	</span><br><span class="line">   public ConfigurableApplicationContext run(String... args) &#123;</span><br><span class="line">	long startTime = System.nanoTime();</span><br><span class="line">	//创建springboot默认的配置上下文</span><br><span class="line">	DefaultBootstrapContext bootstrapContext = createBootstrapContext();</span><br><span class="line">	ConfigurableApplicationContext context = null;</span><br><span class="line">	configureHeadlessProperty();</span><br><span class="line">	//通过类加载器创建spring工厂实例并注册启动监听器</span><br><span class="line">	SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">	listeners.starting(bootstrapContext, this.mainApplicationClass);</span><br><span class="line">	try &#123;</span><br><span class="line">	        //处理参数args成CommandLineArgs对象，具体是把参数分为optionArgs和nonOptionArgs来给下边的环境配置使用</span><br><span class="line">		ApplicationArguments applicationArguments = new DefaultApplicationArguments(args);</span><br><span class="line">		ConfigurableEnvironment environment = prepareEnvironment(listeners, bootstrapContext, applicationArguments);</span><br><span class="line">		configureIgnoreBeanInfo(environment);</span><br><span class="line">		Banner printedBanner = printBanner(environment);</span><br><span class="line">		//创建ConfigurableApplicationContext为单例bean的创建和初始化进行做准备</span><br><span class="line">		context = createApplicationContext();</span><br><span class="line">		context.setApplicationStartup(this.applicationStartup);</span><br><span class="line">		prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">		//这个方法是容器初始化的入口，在方法中调用SpringApplication#refresh方法</span><br><span class="line">		refreshContext(context);</span><br><span class="line">		afterRefresh(context, applicationArguments);</span><br><span class="line">		Duration timeTakenToStartup = Duration.ofNanos(System.nanoTime() - startTime);</span><br><span class="line">		if (this.logStartupInfo) &#123;</span><br><span class="line">			new StartupInfoLogger(this.mainApplicationClass).logStarted(getApplicationLog(), timeTakenToStartup);</span><br><span class="line">		&#125;</span><br><span class="line">		listeners.started(context, timeTakenToStartup);</span><br><span class="line">		callRunners(context, applicationArguments);</span><br><span class="line">	&#125;</span><br><span class="line">	catch (Throwable ex) &#123;</span><br><span class="line">		···</span><br><span class="line">	&#125;</span><br><span class="line">	try &#123;</span><br><span class="line">		···</span><br><span class="line">	&#125;</span><br><span class="line">	catch (Throwable ex) &#123;</span><br><span class="line">		···</span><br><span class="line">	&#125;</span><br><span class="line">	return context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractApplicationContext-refresh"><a href="#AbstractApplicationContext-refresh" class="headerlink" title="AbstractApplicationContext#refresh"></a>AbstractApplicationContext#refresh</h3><p>对应流程图中的2<br>这个方法在学习生命周期的时候会遇到的第一个方法,这个方法主要做spring容器配置以及bean初始化相关</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public void refresh() throws BeansException, IllegalStateException &#123;</span><br><span class="line">    synchronized(this.startupShutdownMonitor) &#123;</span><br><span class="line">        StartupStep contextRefresh = this.applicationStartup.start(&quot;spring.context.refresh&quot;);</span><br><span class="line"> //准备刷新上下文,具体做一些启动日期和活动标志的设置以及执行一些属性资源的初始化</span><br><span class="line">        this.prepareRefresh();</span><br><span class="line"> //创建BeanFactory 具体的逻辑是 如果存在以前的BeanFactory就销毁Bean关闭工厂，重新创建，重新创建完后会调用</span><br><span class="line"> //setSerializationId(getId());customizeBeanFactory(beanFactory);loadBeanDefinitions(beanFactory);这三方法做一些其他配置，这里不细探究</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = this.obtainFreshBeanFactory();</span><br><span class="line"> //配置工厂的标准上下文特征，例如上下文的类加载器和后处理器，后边还有一大堆的set regist 方法都是装备BeanFactory使其功能更完备</span><br><span class="line">        this.prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">   //在标准初始化之后修改应用程序上下文的内部 Bean 工厂，所有 Bean 定义都将被加载，但尚未实例化任何 bean。这允许在某些 </span><br><span class="line">//ApplicationContext 实现中注册特殊的 BeanPostProcessor，这个是空方法，留给子类做扩展使用</span><br><span class="line">            this.postProcessBeanFactory(beanFactory);</span><br><span class="line">            StartupStep beanPostProcess = this.applicationStartup.start(&quot;spring.context.beans.post-process&quot;);</span><br><span class="line">//实例化并调用所有注册的 BeanFactoryPostProcessor bean，如果给定，则遵守显式顺序，必须在单一实例化之前调用。</span><br><span class="line">            this.invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">//实例化并注册所有 BeanPostProcessor的实现类，如果给定顺序，则遵循显式顺序。必须在应用程序 Bean 的任何实例化之前调用。</span><br><span class="line">            this.registerBeanPostProcessors(beanFactory);</span><br><span class="line">            beanPostProcess.end();</span><br><span class="line">//初始化context的MessageSource，用于消息模块的国际化，有两个实现类ResourceBundleMessageSource\ReloadableResourceBundleMessageSource</span><br><span class="line">            this.initMessageSource();</span><br><span class="line">//初始化应用程序事件多播器。如果上下文中未定义任何内容，则使用 SimpleApplicationEventMulticaster。</span><br><span class="line">            this.initApplicationEventMulticaster();</span><br><span class="line">//子类可以重写用来添加特定于上下文的刷新工作。在实例化单例之前调用特殊 bean 的初始化。</span><br><span class="line">            this.onRefresh();</span><br><span class="line">//添加实现 ApplicationListener 的 bean 作为侦听器。不影响其他侦听器，可以在不成为 bean 的情况下添加这些侦听器。</span><br><span class="line">            this.registerListeners();</span><br><span class="line">//对应流程图中的3</span><br><span class="line">//完成beanFactoryd的初始化工作，实例化剩余的非懒加载的单例bean,spring bean初始化的入口也是核心</span><br><span class="line">            this.finishBeanFactoryInitialization(beanFactory);</span><br><span class="line">//完成此上下文的刷新，调用生命周期处理器的 onRefresh（） 方法并发布 ContextRefreshedEvent。</span><br><span class="line">            this.finishRefresh();</span><br><span class="line">        &#125; catch (BeansException var10) &#123;</span><br><span class="line">            if (this.logger.isWarnEnabled()) &#123;</span><br><span class="line">                this.logger.warn(&quot;Exception encountered during context initialization - cancelling refresh attempt: &quot; + var10);</span><br><span class="line">            &#125;</span><br><span class="line">//销毁单例bean</span><br><span class="line">            this.destroyBeans();</span><br><span class="line">//此context的刷新尝试，在引发异常后重置活动标志。将active置为false</span><br><span class="line">            this.cancelRefresh(var10);</span><br><span class="line">            throw var10;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">   //重置 Spring 的公共的元数据缓存，特别是 ReflectionUtils、AnnotationUtils、ResolvevableType 和 CachedIntrospectionResults 缓存。</span><br><span class="line">            this.resetCommonCaches();</span><br><span class="line">//记录步骤的状态以及可能的其他指标，如执行时间。结束后，不允许更改步骤状态。</span><br><span class="line">            contextRefresh.end();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>中间其他非重要步骤掠过</p>
<h3 id="AbstractBeanFactory-doGetBean"><a href="#AbstractBeanFactory-doGetBean" class="headerlink" title="AbstractBeanFactory#doGetBean"></a>AbstractBeanFactory#doGetBean</h3><p>对应流程图中的6<br>创建bean serviceA</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">protected &lt;T&gt; T doGetBean(</span><br><span class="line">		String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object[] args, boolean typeCheckOnly)</span><br><span class="line">		throws BeansException &#123;</span><br><span class="line"></span><br><span class="line">	String beanName = transformedBeanName(name);</span><br><span class="line">	Object beanInstance;</span><br><span class="line"></span><br><span class="line">	// 先看看能不能从缓存中获取到bean 对应流程图中的7-1</span><br><span class="line">	Object sharedInstance = getSingleton(beanName);</span><br><span class="line">	if (sharedInstance != null &amp;&amp; args == null) &#123;</span><br><span class="line">		if (logger.isTraceEnabled()) &#123;</span><br><span class="line">			if (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">				logger.trace(&quot;Returning eagerly cached instance of singleton bean &#x27;&quot; + beanName +</span><br><span class="line">						&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				logger.trace(&quot;Returning cached instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27;&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, null);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	else &#123;</span><br><span class="line">		if (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">			throw new BeanCurrentlyInCreationException(beanName);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Check if bean definition exists in this factory.</span><br><span class="line">		BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line">		if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">			// Not found -&gt; check parent.</span><br><span class="line">			String nameToLookup = originalBeanName(name);</span><br><span class="line">			if (parentBeanFactory instanceof AbstractBeanFactory) &#123;</span><br><span class="line">				return ((AbstractBeanFactory) parentBeanFactory).doGetBean(</span><br><span class="line">						nameToLookup, requiredType, args, typeCheckOnly);</span><br><span class="line">			&#125;</span><br><span class="line">			else if (args != null) &#123;</span><br><span class="line">				// Delegation to parent with explicit args.</span><br><span class="line">				return (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">			&#125;</span><br><span class="line">			else if (requiredType != null) &#123;</span><br><span class="line">				// No args -&gt; delegate to standard getBean method.</span><br><span class="line">				return parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				return (T) parentBeanFactory.getBean(nameToLookup);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (!typeCheckOnly) &#123;</span><br><span class="line">			markBeanAsCreated(beanName);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		StartupStep beanCreation = this.applicationStartup.start(&quot;spring.beans.instantiate&quot;)</span><br><span class="line">				.tag(&quot;beanName&quot;, name);</span><br><span class="line">		try &#123;</span><br><span class="line">			if (requiredType != null) &#123;</span><br><span class="line">				beanCreation.tag(&quot;beanType&quot;, requiredType::toString);</span><br><span class="line">			&#125;</span><br><span class="line">			RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">			checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"></span><br><span class="line">			// Guarantee initialization of beans that the current bean depends on.</span><br><span class="line">			String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">			if (dependsOn != null) &#123;</span><br><span class="line">				for (String dep : dependsOn) &#123;</span><br><span class="line">					if (isDependent(beanName, dep)) &#123;</span><br><span class="line">						throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">								&quot;Circular depends-on relationship between &#x27;&quot; + beanName + &quot;&#x27; and &#x27;&quot; + dep + &quot;&#x27;&quot;);</span><br><span class="line">					&#125;</span><br><span class="line">					registerDependentBean(dep, beanName);</span><br><span class="line">					try &#123;</span><br><span class="line">						getBean(dep);</span><br><span class="line">					&#125;</span><br><span class="line">					catch (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">						throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">								&quot;&#x27;&quot; + beanName + &quot;&#x27; depends on missing bean &#x27;&quot; + dep + &quot;&#x27;&quot;, ex);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			// Create bean instance.</span><br><span class="line">			if (mbd.isSingleton()) &#123;</span><br><span class="line">				// 这里需要注意调用的是getSingleton方法 对应流程图中的7-2</span><br><span class="line">				// 在这个方法中 singletonFactory.getObject()才会进入createBean逻辑</span><br><span class="line">				// createBean就是传入getSingleton方法的参数singletonFactory</span><br><span class="line">				sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">					try &#123;</span><br><span class="line">						return createBean(beanName, mbd, args);</span><br><span class="line">					&#125;</span><br><span class="line">					catch (BeansException ex) &#123;</span><br><span class="line">						destroySingleton(beanName);</span><br><span class="line">						throw ex;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">				beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			else if (mbd.isPrototype()) &#123;</span><br><span class="line">				//···</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			else &#123;</span><br><span class="line">				//···</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		catch (BeansException ex) &#123;</span><br><span class="line">			//···</span><br><span class="line">		&#125;</span><br><span class="line">		finally &#123;</span><br><span class="line">			beanCreation.end();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return adaptBeanInstance(name, beanInstance, requiredType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="DefaultSingletonBeanRegistry-getSingleton-String-beanName"><a href="#DefaultSingletonBeanRegistry-getSingleton-String-beanName" class="headerlink" title="DefaultSingletonBeanRegistry#getSingleton(String beanName)"></a>DefaultSingletonBeanRegistry#getSingleton(String beanName)</h3><p>对应流程图中的7-1<br>尝试从从缓存中获取bean serviceA</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public Object getSingleton(String beanName) &#123;</span><br><span class="line">	return getSingleton(beanName, true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Nullable</span><br><span class="line">protected Object getSingleton(String beanName, boolean allowEarlyReference) &#123;</span><br><span class="line">	// 先从一级缓存中获取bean </span><br><span class="line">	Object singletonObject = this.singletonObjects.get(beanName);</span><br><span class="line">	if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">		// 从二级缓存中获取bean</span><br><span class="line">		singletonObject = this.earlySingletonObjects.get(beanName);</span><br><span class="line">		if (singletonObject == null &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">			synchronized (this.singletonObjects) &#123;</span><br><span class="line">				// Consistent creation of early reference within full singleton lock</span><br><span class="line">				singletonObject = this.singletonObjects.get(beanName);</span><br><span class="line">				if (singletonObject == null) &#123;</span><br><span class="line">					singletonObject = this.earlySingletonObjects.get(beanName);</span><br><span class="line">					if (singletonObject == null) &#123;</span><br><span class="line">						ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName);</span><br><span class="line">						if (singletonFactory != null) &#123;</span><br><span class="line">							// 从三级缓存中获取</span><br><span class="line">							singletonObject = singletonFactory.getObject();</span><br><span class="line">							// 放入二级缓存</span><br><span class="line">							this.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">							// 删除三级缓存</span><br><span class="line">							this.singletonFactories.remove(beanName);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return singletonObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以很清楚的看到，spring从缓存中获取bean 先从”一级缓存”找，有就返回，没有就找”二级缓存”；如果”二级缓存”有，就返回，没有就找”三级缓存”；如果”三级缓存”找到了，就获取对象，放入”二级缓存”，从”三级缓存”移除。</p>
<h3 id="DefaultSingletonBeanRegistry-getSingleton-String-beanName-ObjectFactory-lt-gt-singletonFactory"><a href="#DefaultSingletonBeanRegistry-getSingleton-String-beanName-ObjectFactory-lt-gt-singletonFactory" class="headerlink" title="DefaultSingletonBeanRegistry#getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory)"></a>DefaultSingletonBeanRegistry#getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</h3><p>对应流程图中的7-2<br>先从一级缓存中获取，获取不到就创建，需要注意，该方法的第二个参数是lambda函数式(该参数包含某些的逻辑 此处singletonFactory就是createBean方法)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">public Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123;</span><br><span class="line">	Assert.notNull(beanName, &quot;Bean name must not be null&quot;);</span><br><span class="line">	synchronized (this.singletonObjects) &#123;</span><br><span class="line">		// 先从一级缓存中获取bean</span><br><span class="line">		Object singletonObject = this.singletonObjects.get(beanName);</span><br><span class="line">		if (singletonObject == null) &#123;</span><br><span class="line">			if (this.singletonsCurrentlyInDestruction) &#123;</span><br><span class="line">				throw new BeanCreationNotAllowedException(beanName,</span><br><span class="line">						&quot;Singleton bean creation not allowed while singletons of this factory are in destruction &quot; +</span><br><span class="line">						&quot;(Do not request a bean from a BeanFactory in a destroy method implementation!)&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			if (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(&quot;Creating shared instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27;&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			beforeSingletonCreation(beanName);</span><br><span class="line">			boolean newSingleton = false;</span><br><span class="line">			boolean recordSuppressedExceptions = (this.suppressedExceptions == null);</span><br><span class="line">			if (recordSuppressedExceptions) &#123;</span><br><span class="line">				this.suppressedExceptions = new LinkedHashSet&lt;&gt;();</span><br><span class="line">			&#125;</span><br><span class="line">			try &#123;</span><br><span class="line">				// 获取不到就创建 通过传入的参数singletonFactory也就是createBean的代码块逻辑</span><br><span class="line">				// 对应流程图中的8</span><br><span class="line">				singletonObject = singletonFactory.getObject();</span><br><span class="line">				newSingleton = true;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (IllegalStateException ex) &#123;</span><br><span class="line">				// Has the singleton object implicitly appeared in the meantime -&gt;</span><br><span class="line">				// if yes, proceed with it since the exception indicates that state.</span><br><span class="line">				singletonObject = this.singletonObjects.get(beanName);</span><br><span class="line">				if (singletonObject == null) &#123;</span><br><span class="line">					throw ex;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (BeanCreationException ex) &#123;</span><br><span class="line">				if (recordSuppressedExceptions) &#123;</span><br><span class="line">					for (Exception suppressedException : this.suppressedExceptions) &#123;</span><br><span class="line">						ex.addRelatedCause(suppressedException);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				throw ex;</span><br><span class="line">			&#125;</span><br><span class="line">			finally &#123;</span><br><span class="line">				if (recordSuppressedExceptions) &#123;</span><br><span class="line">					this.suppressedExceptions = null;</span><br><span class="line">				&#125;</span><br><span class="line">				afterSingletonCreation(beanName);</span><br><span class="line">			&#125;</span><br><span class="line">			if (newSingleton) &#123;</span><br><span class="line">				// 这里先有个眼熟 </span><br><span class="line">				addSingleton(beanName, singletonObject);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return singletonObject;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractAutowireCapableBeanFactory-doCreateBean"><a href="#AbstractAutowireCapableBeanFactory-doCreateBean" class="headerlink" title="AbstractAutowireCapableBeanFactory#doCreateBean"></a>AbstractAutowireCapableBeanFactory#doCreateBean</h3><p>对应流程图9<br>创建bean方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">protected Object doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)</span><br><span class="line">		throws BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">	// Instantiate the bean.</span><br><span class="line">	BeanWrapper instanceWrapper = null;</span><br><span class="line">	if (mbd.isSingleton()) &#123;</span><br><span class="line">		instanceWrapper = this.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">	&#125;</span><br><span class="line">	if (instanceWrapper == null) &#123;</span><br><span class="line">		instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">	&#125;</span><br><span class="line">	Object bean = instanceWrapper.getWrappedInstance();</span><br><span class="line">	Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br><span class="line">	if (beanType != NullBean.class) &#123;</span><br><span class="line">		mbd.resolvedTargetType = beanType;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Allow post-processors to modify the merged bean definition.</span><br><span class="line">	synchronized (mbd.postProcessingLock) &#123;</span><br><span class="line">		if (!mbd.postProcessed) &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Throwable ex) &#123;</span><br><span class="line">				throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">						&quot;Post-processing of merged bean definition failed&quot;, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			mbd.postProcessed = true;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Eagerly cache singletons to be able to resolve circular references</span><br><span class="line">	// even when triggered by lifecycle interfaces like BeanFactoryAware.</span><br><span class="line">	boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp;</span><br><span class="line">			isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">	if (earlySingletonExposure) &#123;</span><br><span class="line">		if (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(&quot;Eagerly caching bean &#x27;&quot; + beanName +</span><br><span class="line">					&quot;&#x27; to allow for resolving potential circular references&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		// 先把生成bean的工厂放到三级缓存中 对应流程图10 和流程图10-3</span><br><span class="line">		addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Initialize the bean instance.</span><br><span class="line">	Object exposedObject = bean;</span><br><span class="line">	try &#123;</span><br><span class="line">		// 为bean进行属性赋值依赖注入 对应流程图11</span><br><span class="line">		populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">		// 初始化bean 这步走完 bean就可以使用了</span><br><span class="line">		exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">	&#125;</span><br><span class="line">	catch (Throwable ex) &#123;</span><br><span class="line">		//···</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (earlySingletonExposure) &#123;</span><br><span class="line">		Object earlySingletonReference = getSingleton(beanName, false);</span><br><span class="line">		if (earlySingletonReference != null) &#123;</span><br><span class="line">			if (exposedObject == bean) &#123;</span><br><span class="line">				exposedObject = earlySingletonReference;</span><br><span class="line">			&#125;</span><br><span class="line">			else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</span><br><span class="line">				//···</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Register bean as disposable.</span><br><span class="line">	try &#123;</span><br><span class="line">		registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">	&#125;</span><br><span class="line">	catch (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">		//···</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DefaultSingletonBeanRegistry-addSingletonFactory"><a href="#DefaultSingletonBeanRegistry-addSingletonFactory" class="headerlink" title="DefaultSingletonBeanRegistry#addSingletonFactory"></a>DefaultSingletonBeanRegistry#addSingletonFactory</h3><p>对应流程图10<br>把创建bean的工厂放到三级缓存中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">protected void addSingletonFactory(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123;</span><br><span class="line">	Assert.notNull(singletonFactory, &quot;Singleton factory must not be null&quot;);</span><br><span class="line">	synchronized (this.singletonObjects) &#123;</span><br><span class="line">		if (!this.singletonObjects.containsKey(beanName)) &#123;</span><br><span class="line">			// 三级缓存赋值</span><br><span class="line">			this.singletonFactories.put(beanName, singletonFactory);</span><br><span class="line">			// 删除二级缓存</span><br><span class="line">			this.earlySingletonObjects.remove(beanName);</span><br><span class="line">			this.registeredSingletons.add(beanName);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractAutoProxyCreator-wrapIfNecessary"><a href="#AbstractAutoProxyCreator-wrapIfNecessary" class="headerlink" title="AbstractAutoProxyCreator#wrapIfNecessary"></a>AbstractAutoProxyCreator#wrapIfNecessary</h3><p>对应流程图10-3<br>工厂产生的bean的细节</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123;</span><br><span class="line">	if (StringUtils.hasLength(beanName) &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">		return bean;</span><br><span class="line">	&#125;</span><br><span class="line">	if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line">		return bean;</span><br><span class="line">	&#125;</span><br><span class="line">	if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line">		this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">		return bean;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 看看bean是否需要创建代理</span><br><span class="line">	Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);</span><br><span class="line">	if (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line">		this.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line">		Object proxy = createProxy(</span><br><span class="line">				bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));</span><br><span class="line">		this.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">		// 返回代理</span><br><span class="line">		return proxy;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">	// 返回原始的bean</span><br><span class="line">	return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以很明显的看到工厂可以产生代理bean或者原始bean，为什么”三级缓存”不直接存半成品的bean，而是要存一个代理工厂呢 ？答案是因为动态代理(Aop或事务需要)。</p>
<h3 id="AbstractAutowireCapableBeanFactory-populateBean"><a href="#AbstractAutowireCapableBeanFactory-populateBean" class="headerlink" title="AbstractAutowireCapableBeanFactory#populateBean"></a>AbstractAutowireCapableBeanFactory#populateBean</h3><p>对应流程图11<br>为bean进行属性赋值 依赖注入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">protected void populateBean(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) &#123;</span><br><span class="line">	if (bw == null) &#123;</span><br><span class="line">		if (mbd.hasPropertyValues()) &#123;</span><br><span class="line">			//···</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			// Skip property population phase for null instance.</span><br><span class="line">			return;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">		for (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123;</span><br><span class="line">			if (!bp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;</span><br><span class="line">				return;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : null);</span><br><span class="line"></span><br><span class="line">	int resolvedAutowireMode = mbd.getResolvedAutowireMode();</span><br><span class="line">	if (resolvedAutowireMode == AUTOWIRE_BY_NAME || resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">		MutablePropertyValues newPvs = new MutablePropertyValues(pvs);</span><br><span class="line">		// Add property values based on autowire by name if applicable.</span><br><span class="line">		if (resolvedAutowireMode == AUTOWIRE_BY_NAME) &#123;</span><br><span class="line">			autowireByName(beanName, mbd, bw, newPvs);</span><br><span class="line">		&#125;</span><br><span class="line">		// Add property values based on autowire by type if applicable.</span><br><span class="line">		if (resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">			autowireByType(beanName, mbd, bw, newPvs);</span><br><span class="line">		&#125;</span><br><span class="line">		pvs = newPvs;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	boolean hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors();</span><br><span class="line">	boolean needsDepCheck = (mbd.getDependencyCheck() != AbstractBeanDefinition.DEPENDENCY_CHECK_NONE);</span><br><span class="line"></span><br><span class="line">	PropertyDescriptor[] filteredPds = null;</span><br><span class="line">	if (hasInstAwareBpps) &#123;</span><br><span class="line">		if (pvs == null) &#123;</span><br><span class="line">			pvs = mbd.getPropertyValues();</span><br><span class="line">		&#125;</span><br><span class="line">		for (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123;</span><br><span class="line">			// 执行postProcessProperties方法 对应流程图12</span><br><span class="line">			// 如果是@Autowired注解注入的 要看AutowiredAnnotationBeanPostProcessor的实现</span><br><span class="line">			// 如果是@Resource注解注入的 要看CommonAnnotationBeanPostProcessor的实现</span><br><span class="line">			// 其实都差不多，主要是为了获取依赖注入的bean</span><br><span class="line">			PropertyValues pvsToUse = bp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);</span><br><span class="line">			if (pvsToUse == null) &#123;</span><br><span class="line">				if (filteredPds == null) &#123;</span><br><span class="line">					filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</span><br><span class="line">				&#125;</span><br><span class="line">				pvsToUse = bp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);</span><br><span class="line">				if (pvsToUse == null) &#123;</span><br><span class="line">					return;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			pvs = pvsToUse;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if (needsDepCheck) &#123;</span><br><span class="line">		if (filteredPds == null) &#123;</span><br><span class="line">			filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</span><br><span class="line">		&#125;</span><br><span class="line">		checkDependencies(beanName, mbd, filteredPds, pvs);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (pvs != null) &#123;</span><br><span class="line">		applyPropertyValues(beanName, mbd, bw, pvs);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AutowiredAnnotationBeanPostProcessor-postProcessProperties"><a href="#AutowiredAnnotationBeanPostProcessor-postProcessProperties" class="headerlink" title="AutowiredAnnotationBeanPostProcessor#postProcessProperties"></a>AutowiredAnnotationBeanPostProcessor#postProcessProperties</h3><p>对应流程图12<br>获取注入的bean 这里是serviceA的创建流程，需要注入serviceB</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public PropertyValues postProcessProperties(PropertyValues pvs, Object bean, String beanName) &#123;</span><br><span class="line">	// 查找注入的类 找到的就是serviceB</span><br><span class="line">	InjectionMetadata metadata = findAutowiringMetadata(beanName, bean.getClass(), pvs);</span><br><span class="line">	try &#123;</span><br><span class="line">		// 为serviceA注入serviceB 对应流程图13</span><br><span class="line">		metadata.inject(bean, beanName, pvs);</span><br><span class="line">	&#125;</span><br><span class="line">	catch (BeanCreationException ex) &#123;</span><br><span class="line">		throw ex;</span><br><span class="line">	&#125;</span><br><span class="line">	catch (Throwable ex) &#123;</span><br><span class="line">		throw new BeanCreationException(beanName, &quot;Injection of autowired dependencies failed&quot;, ex);</span><br><span class="line">	&#125;</span><br><span class="line">	return pvs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="InjectionMetadata-inject"><a href="#InjectionMetadata-inject" class="headerlink" title="InjectionMetadata#inject"></a>InjectionMetadata#inject</h3><p>对应流程图13</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void inject(Object target, @Nullable String beanName, @Nullable PropertyValues pvs) throws Throwable &#123;</span><br><span class="line">	Collection&lt;InjectedElement&gt; checkedElements = this.checkedElements;</span><br><span class="line">	Collection&lt;InjectedElement&gt; elementsToIterate =</span><br><span class="line">			(checkedElements != null ? checkedElements : this.injectedElements);</span><br><span class="line">	if (!elementsToIterate.isEmpty()) &#123;</span><br><span class="line">		for (InjectedElement element : elementsToIterate) &#123;</span><br><span class="line">			// 真正的注入方法 对应流程图14</span><br><span class="line">			element.inject(target, beanName, pvs);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AutowiredFieldElement-inject"><a href="#AutowiredFieldElement-inject" class="headerlink" title="AutowiredFieldElement#inject"></a>AutowiredFieldElement#inject</h3><p>对应流程图14</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">protected void inject(Object bean, @Nullable String beanName, @Nullable PropertyValues pvs) throws Throwable &#123;</span><br><span class="line">	Field field = (Field) this.member;</span><br><span class="line">	Object value;</span><br><span class="line">	if (this.cached) &#123;</span><br><span class="line">		try &#123;</span><br><span class="line">			value = resolvedCachedArgument(beanName, this.cachedFieldValue);</span><br><span class="line">		&#125;</span><br><span class="line">		catch (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">			// Unexpected removal of target bean for cached argument -&gt; re-resolve</span><br><span class="line">			value = resolveFieldValue(field, bean, beanName);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		// 解析依赖的字段值serviceB 对应流程图15</span><br><span class="line">		value = resolveFieldValue(field, bean, beanName);</span><br><span class="line">	&#125;</span><br><span class="line">	if (value != null) &#123;</span><br><span class="line">		ReflectionUtils.makeAccessible(field);</span><br><span class="line">		field.set(bean, value);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AutowiredAnnotationBeanPostProcessor-resolveFieldValue"><a href="#AutowiredAnnotationBeanPostProcessor-resolveFieldValue" class="headerlink" title="AutowiredAnnotationBeanPostProcessor#resolveFieldValue"></a>AutowiredAnnotationBeanPostProcessor#resolveFieldValue</h3><p>对应流程图15<br>解析依赖的字段属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private Object resolveFieldValue(Field field, Object bean, @Nullable String beanName) &#123;</span><br><span class="line">			DependencyDescriptor desc = new DependencyDescriptor(field, this.required);</span><br><span class="line">			desc.setContainingClass(bean.getClass());</span><br><span class="line">			Set&lt;String&gt; autowiredBeanNames = new LinkedHashSet&lt;&gt;(1);</span><br><span class="line">			Assert.state(beanFactory != null, &quot;No BeanFactory available&quot;);</span><br><span class="line">			TypeConverter typeConverter = beanFactory.getTypeConverter();</span><br><span class="line">			Object value;</span><br><span class="line">			try &#123;</span><br><span class="line">				// 解析属性对应的依赖 对应流程图16</span><br><span class="line">				value = beanFactory.resolveDependency(desc, beanName, autowiredBeanNames, typeConverter);</span><br><span class="line">			&#125;</span><br><span class="line">			catch (BeansException ex) &#123;</span><br><span class="line">				throw new UnsatisfiedDependencyException(null, beanName, new InjectionPoint(field), ex);</span><br><span class="line">			&#125;</span><br><span class="line">			synchronized (this) &#123;</span><br><span class="line">				if (!this.cached) &#123;</span><br><span class="line">					Object cachedFieldValue = null;</span><br><span class="line">					if (value != null || this.required) &#123;</span><br><span class="line">						// ···</span><br><span class="line">					&#125;</span><br><span class="line">					this.cachedFieldValue = cachedFieldValue;</span><br><span class="line">					this.cached = true;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			return value;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DefaultListableBeanFactory-resolveDependency"><a href="#DefaultListableBeanFactory-resolveDependency" class="headerlink" title="DefaultListableBeanFactory#resolveDependency"></a>DefaultListableBeanFactory#resolveDependency</h3><p>对应流程图16<br>解析属性对应的依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public Object resolveDependency(DependencyDescriptor descriptor, @Nullable String requestingBeanName,</span><br><span class="line">		@Nullable Set&lt;String&gt; autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException &#123;</span><br><span class="line"></span><br><span class="line">	descriptor.initParameterNameDiscovery(getParameterNameDiscoverer());</span><br><span class="line">	if (Optional.class == descriptor.getDependencyType()) &#123;</span><br><span class="line">		return createOptionalDependency(descriptor, requestingBeanName);</span><br><span class="line">	&#125;</span><br><span class="line">	else if (ObjectFactory.class == descriptor.getDependencyType() ||</span><br><span class="line">			ObjectProvider.class == descriptor.getDependencyType()) &#123;</span><br><span class="line">		return new DependencyObjectProvider(descriptor, requestingBeanName);</span><br><span class="line">	&#125;</span><br><span class="line">	else if (javaxInjectProviderClass == descriptor.getDependencyType()) &#123;</span><br><span class="line">		return new Jsr330Factory().createDependencyProvider(descriptor, requestingBeanName);</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		Object result = getAutowireCandidateResolver().getLazyResolutionProxyIfNecessary(</span><br><span class="line">				descriptor, requestingBeanName);</span><br><span class="line">		if (result == null) &#123;</span><br><span class="line">			// 解析依赖 对应流程图17</span><br><span class="line">			result = doResolveDependency(descriptor, requestingBeanName, autowiredBeanNames, typeConverter);</span><br><span class="line">		&#125;</span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DefaultListableBeanFactory-doResolveDependency"><a href="#DefaultListableBeanFactory-doResolveDependency" class="headerlink" title="DefaultListableBeanFactory#doResolveDependency"></a>DefaultListableBeanFactory#doResolveDependency</h3><p>对应流程图17<br>解析依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">public Object doResolveDependency(DependencyDescriptor descriptor, @Nullable String beanName,</span><br><span class="line">			@Nullable Set&lt;String&gt; autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException &#123;</span><br><span class="line"></span><br><span class="line">		InjectionPoint previousInjectionPoint = ConstructorResolver.setCurrentInjectionPoint(descriptor);</span><br><span class="line">		try &#123;</span><br><span class="line">			Object shortcut = descriptor.resolveShortcut(this);</span><br><span class="line">			if (shortcut != null) &#123;</span><br><span class="line">				return shortcut;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			Class&lt;?&gt; type = descriptor.getDependencyType();</span><br><span class="line">			Object value = getAutowireCandidateResolver().getSuggestedValue(descriptor);</span><br><span class="line">			if (value != null) &#123;</span><br><span class="line">				if (value instanceof String) &#123;</span><br><span class="line">					String strVal = resolveEmbeddedValue((String) value);</span><br><span class="line">					BeanDefinition bd = (beanName != null &amp;&amp; containsBean(beanName) ?</span><br><span class="line">							getMergedBeanDefinition(beanName) : null);</span><br><span class="line">					value = evaluateBeanDefinitionString(strVal, bd);</span><br><span class="line">				&#125;</span><br><span class="line">				TypeConverter converter = (typeConverter != null ? typeConverter : getTypeConverter());</span><br><span class="line">				try &#123;</span><br><span class="line">					return converter.convertIfNecessary(value, type, descriptor.getTypeDescriptor());</span><br><span class="line">				&#125;</span><br><span class="line">				catch (UnsupportedOperationException ex) &#123;</span><br><span class="line">					// A custom TypeConverter which does not support TypeDescriptor resolution...</span><br><span class="line">					return (descriptor.getField() != null ?</span><br><span class="line">							converter.convertIfNecessary(value, type, descriptor.getField()) :</span><br><span class="line">							converter.convertIfNecessary(value, type, descriptor.getMethodParameter()));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			Object multipleBeans = resolveMultipleBeans(descriptor, beanName, autowiredBeanNames, typeConverter);</span><br><span class="line">			if (multipleBeans != null) &#123;</span><br><span class="line">				return multipleBeans;</span><br><span class="line">			&#125;</span><br><span class="line">			// 获取和属性匹配的class 存放到LinkedHashMap</span><br><span class="line">			Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, type, descriptor);</span><br><span class="line">			if (matchingBeans.isEmpty()) &#123;</span><br><span class="line">				if (isRequired(descriptor)) &#123;</span><br><span class="line">					raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);</span><br><span class="line">				&#125;</span><br><span class="line">				return null;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			String autowiredBeanName;</span><br><span class="line">			Object instanceCandidate;</span><br><span class="line"></span><br><span class="line">			if (matchingBeans.size() &gt; 1) &#123;</span><br><span class="line">				autowiredBeanName = determineAutowireCandidate(matchingBeans, descriptor);</span><br><span class="line">				if (autowiredBeanName == null) &#123;</span><br><span class="line">					if (isRequired(descriptor) || !indicatesMultipleBeans(type)) &#123;</span><br><span class="line">						return descriptor.resolveNotUnique(descriptor.getResolvableType(), matchingBeans);</span><br><span class="line">					&#125;</span><br><span class="line">					else &#123;</span><br><span class="line">						// In case of an optional Collection/Map, silently ignore a non-unique case:</span><br><span class="line">						// possibly it was meant to be an empty collection of multiple regular beans</span><br><span class="line">						// (before 4.3 in particular when we didn&#x27;t even look for collection beans).</span><br><span class="line">						return null;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				instanceCandidate = matchingBeans.get(autowiredBeanName);</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				// 获取匹配的key value key就是serviceB value就是com.xc.springcirculardependency.service.ServiceB</span><br><span class="line">				Map.Entry&lt;String, Object&gt; entry = matchingBeans.entrySet().iterator().next();</span><br><span class="line">				autowiredBeanName = entry.getKey();</span><br><span class="line">				instanceCandidate = entry.getValue();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			if (autowiredBeanNames != null) &#123;</span><br><span class="line">				autowiredBeanNames.add(autowiredBeanName);</span><br><span class="line">			&#125;</span><br><span class="line">			if (instanceCandidate instanceof Class) &#123;</span><br><span class="line">				// 解析依赖 对应流程图18</span><br><span class="line">				instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, this);</span><br><span class="line">			&#125;</span><br><span class="line">			Object result = instanceCandidate;</span><br><span class="line">			if (result instanceof NullBean) &#123;</span><br><span class="line">				if (isRequired(descriptor)) &#123;</span><br><span class="line">					raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);</span><br><span class="line">				&#125;</span><br><span class="line">				result = null;</span><br><span class="line">			&#125;</span><br><span class="line">			if (!ClassUtils.isAssignableValue(type, result)) &#123;</span><br><span class="line">				throw new BeanNotOfRequiredTypeException(autowiredBeanName, type, instanceCandidate.getClass());</span><br><span class="line">			&#125;</span><br><span class="line">			return result;</span><br><span class="line">		&#125;</span><br><span class="line">		finally &#123;</span><br><span class="line">			ConstructorResolver.setCurrentInjectionPoint(previousInjectionPoint);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DependencyDescriptor-resolveCandidate"><a href="#DependencyDescriptor-resolveCandidate" class="headerlink" title="DependencyDescriptor#resolveCandidate"></a>DependencyDescriptor#resolveCandidate</h3><p>对应流程图18<br>注意从开始到现在的主线流程都是serviceA初始化，需要属性赋值serviceB，然后依赖注入，到这一步是获取serviceB的bean，获取到了才能给serviceA进行注入，然后继续serviceA的初始化 这里是获取依赖的serviceB的bean</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public Object resolveCandidate(String beanName, Class&lt;?&gt; requiredType, BeanFactory beanFactory)</span><br><span class="line">		throws BeansException &#123;</span><br><span class="line">	// 获取serviceB的bean 对应流程图19</span><br><span class="line">	return beanFactory.getBean(beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractBeanFactory-doGetBean-1"><a href="#AbstractBeanFactory-doGetBean-1" class="headerlink" title="AbstractBeanFactory#doGetBean"></a>AbstractBeanFactory#doGetBean</h3><p>对应流程图19<br>获取serviceA依赖的bean serviceB</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Object getBean(String name) throws BeansException &#123;</span><br><span class="line">	return doGetBean(name, null, null, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>20-1 ~ 32是serviceB的创建过程和servcieA之前的一样，就不在重复写，直接从流程图32开始，开始之前先屡一下流程，主线流程servcieA创建过程，在属性注入的时候需要依赖servcieB，解析依赖的属性并且来到doGetBean方法获取serviceB，先是从三级缓存中尝试获取serviceB，没获取到开始serviceB的创建过程，在serviceB的属性注入的时候发现需要依赖servcieA，解析依赖的属性并且来到doGetBean方法获取serviceA。</p>
<h3 id="AbstractBeanFactory-doGetBean-2"><a href="#AbstractBeanFactory-doGetBean-2" class="headerlink" title="AbstractBeanFactory#doGetBean"></a>AbstractBeanFactory#doGetBean</h3><p>对应流程图32<br>获取serviceB依赖的bean serviceA</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public Object getBean(String name) throws BeansException &#123;</span><br><span class="line">	// 对应流程图32</span><br><span class="line">	return doGetBean(name, null, null, false);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected &lt;T&gt; T doGetBean(</span><br><span class="line">		String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object[] args, boolean typeCheckOnly)</span><br><span class="line">		throws BeansException &#123;</span><br><span class="line"></span><br><span class="line">	String beanName = transformedBeanName(name);</span><br><span class="line">	Object beanInstance;</span><br><span class="line"></span><br><span class="line">	// 从缓存中获取servcieA 对应流程图33</span><br><span class="line">	Object sharedInstance = getSingleton(beanName);</span><br><span class="line">	if (sharedInstance != null &amp;&amp; args == null) &#123;</span><br><span class="line">		if (logger.isTraceEnabled()) &#123;</span><br><span class="line">			if (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">				logger.trace(&quot;Returning eagerly cached instance of singleton bean &#x27;&quot; + beanName +</span><br><span class="line">						&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				logger.trace(&quot;Returning cached instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27;&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, null);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	else &#123;</span><br><span class="line">		//···</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return adaptBeanInstance(name, beanInstance, requiredType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DefaultListableBeanFactory-getSingleton-String-beanName"><a href="#DefaultListableBeanFactory-getSingleton-String-beanName" class="headerlink" title="DefaultListableBeanFactory#getSingleton(String beanName)"></a>DefaultListableBeanFactory#getSingleton(String beanName)</h3><p>对应流程图33<br>尝试从缓存中获取serviceA 这里是可以从三级缓存中获取到servcieA的，不过得到的servcieA是半成品(servcieB都还没注入呢)，因为在之前serviceA的创建过程中 对第三级的缓存singletonFactories赋了值创建”serviceA的创建工厂”(之前的步骤中 对应流程图10)，所以可以直接通过工厂生成serviceA半成品</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">protected Object getSingleton(String beanName, boolean allowEarlyReference) &#123;</span><br><span class="line">	// 先从一级缓存中获取bean  serviceA </span><br><span class="line">	Object singletonObject = this.singletonObjects.get(beanName);</span><br><span class="line">	if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">		// 从二级缓存中获取bean serviceA</span><br><span class="line">		singletonObject = this.earlySingletonObjects.get(beanName);</span><br><span class="line">		if (singletonObject == null &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">			synchronized (this.singletonObjects) &#123;</span><br><span class="line">				// Consistent creation of early reference within full singleton lock</span><br><span class="line">				singletonObject = this.singletonObjects.get(beanName);</span><br><span class="line">				if (singletonObject == null) &#123;</span><br><span class="line">					singletonObject = this.earlySingletonObjects.get(beanName);</span><br><span class="line">					if (singletonObject == null) &#123;</span><br><span class="line">						ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName);</span><br><span class="line">						if (singletonFactory != null) &#123;</span><br><span class="line">							// 从三级缓存中获取 serviceA 可以获取到</span><br><span class="line">							singletonObject = singletonFactory.getObject();</span><br><span class="line">							// 放入二级缓存</span><br><span class="line">							this.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">							// 删除三级缓存</span><br><span class="line">							this.singletonFactories.remove(beanName);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return singletonObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到servcieB依赖的serviceA之后，继续回到serviceB的创建过程，创建完成后回到入口(getSingleton(String beanName,()-&gt;{createBean()})),这时候还是在getSingleton方法体中</p>
<h3 id="DefaultSingletonBeanRegistry-getSingleton-String-beanName-ObjectFactory-lt-gt-singletonFactory-1"><a href="#DefaultSingletonBeanRegistry-getSingleton-String-beanName-ObjectFactory-lt-gt-singletonFactory-1" class="headerlink" title="DefaultSingletonBeanRegistry#getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory)"></a>DefaultSingletonBeanRegistry#getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</h3><p>对应流程图34</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123;</span><br><span class="line">	Assert.notNull(beanName, &quot;Bean name must not be null&quot;);</span><br><span class="line">	synchronized (this.singletonObjects) &#123;</span><br><span class="line">		Object singletonObject = this.singletonObjects.get(beanName);</span><br><span class="line">		if (singletonObject == null) &#123;</span><br><span class="line">			if (this.singletonsCurrentlyInDestruction) &#123;</span><br><span class="line">				//···</span><br><span class="line">			&#125;</span><br><span class="line">			if (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(&quot;Creating shared instance of singleton bean &#x27;&quot; + beanName + &quot;&#x27;&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			beforeSingletonCreation(beanName);</span><br><span class="line">			boolean newSingleton = false;</span><br><span class="line">			boolean recordSuppressedExceptions = (this.suppressedExceptions == null);</span><br><span class="line">			if (recordSuppressedExceptions) &#123;</span><br><span class="line">				this.suppressedExceptions = new LinkedHashSet&lt;&gt;();</span><br><span class="line">			&#125;</span><br><span class="line">			try &#123;</span><br><span class="line">				// 这里是真正执行的createBean方法 从这里出来后得到了serviceB真正的bean</span><br><span class="line">				singletonObject = singletonFactory.getObject();</span><br><span class="line">				newSingleton = true;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (IllegalStateException ex) &#123;</span><br><span class="line">				// Has the singleton object implicitly appeared in the meantime -&gt;</span><br><span class="line">				// if yes, proceed with it since the exception indicates that state.</span><br><span class="line">				singletonObject = this.singletonObjects.get(beanName);</span><br><span class="line">				if (singletonObject == null) &#123;</span><br><span class="line">					throw ex;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (BeanCreationException ex) &#123;</span><br><span class="line">				if (recordSuppressedExceptions) &#123;</span><br><span class="line">					for (Exception suppressedException : this.suppressedExceptions) &#123;</span><br><span class="line">						ex.addRelatedCause(suppressedException);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				throw ex;</span><br><span class="line">			&#125;</span><br><span class="line">			finally &#123;</span><br><span class="line">				if (recordSuppressedExceptions) &#123;</span><br><span class="line">					this.suppressedExceptions = null;</span><br><span class="line">				&#125;</span><br><span class="line">				afterSingletonCreation(beanName);</span><br><span class="line">			&#125;</span><br><span class="line">			if (newSingleton) &#123;</span><br><span class="line">				// 之前是混个眼熟 现在就不是了 调整缓存 对应流程图35</span><br><span class="line">				addSingleton(beanName, singletonObject);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return singletonObject;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DefaultSingletonBeanRegistry-addSingleton"><a href="#DefaultSingletonBeanRegistry-addSingleton" class="headerlink" title="DefaultSingletonBeanRegistry#addSingleton"></a>DefaultSingletonBeanRegistry#addSingleton</h3><p>对应流程图35<br>创建完成的serviceB放入一级缓存 删除二、三级缓存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">protected void addSingleton(String beanName, Object singletonObject) &#123;</span><br><span class="line">	synchronized (this.singletonObjects) &#123;</span><br><span class="line">		// 放入一级缓存</span><br><span class="line">		this.singletonObjects.put(beanName, singletonObject);</span><br><span class="line">		// 删除三级缓存</span><br><span class="line">		this.singletonFactories.remove(beanName);</span><br><span class="line">		// 删除二级缓存</span><br><span class="line">		this.earlySingletonObjects.remove(beanName);</span><br><span class="line">		this.registeredSingletons.add(beanName);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里在屡一下：主流程是serviceA的创建过程，属性赋值时候需要依赖serviceB，没有serviceB，就创建，创建完成后把serviceB放到一级缓存，然后继续进行serviceA的属性赋值，可以注入serviceB了，然后serviceA就可以继续创建完成，创建完成以后回到创建入口(getSingleton(String beanName, ()-&gt;{createBean})),在getSingleton方法体中，最后调用addSingleton方法同样把servcieA放到一级缓存中，删除二三级缓存</p>
<h3 id="DefaultSingletonBeanRegistry-addSingleton-1"><a href="#DefaultSingletonBeanRegistry-addSingleton-1" class="headerlink" title="DefaultSingletonBeanRegistry#addSingleton"></a>DefaultSingletonBeanRegistry#addSingleton</h3><p>对应流程图36<br>创建完成的serviceA放入一级缓存 删除二、三级缓存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">protected void addSingleton(String beanName, Object singletonObject) &#123;</span><br><span class="line">	synchronized (this.singletonObjects) &#123;</span><br><span class="line">		// 放入一级缓存</span><br><span class="line">		this.singletonObjects.put(beanName, singletonObject);</span><br><span class="line">		// 删除三级缓存</span><br><span class="line">		this.singletonFactories.remove(beanName);</span><br><span class="line">		// 删除二级缓存</span><br><span class="line">		this.earlySingletonObjects.remove(beanName);</span><br><span class="line">		this.registeredSingletons.add(beanName);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>“一级缓存singletonObjects”结构是一个ConcurrentHashMap,是一个单例池，将初始化好的对象放到里面，给其它线程使用，如果没有第一级缓存，程序不能保证 Spring 的单例属性。<br>“二级缓存earlySingletonObjects”结构是一个ConcurrentHashMap,存放对象工厂生成的对象(半成品单例bean)，这个对象可能是原对象，也可能是个代理对象，避免了 AOP 创建多个对象。<br>“三级缓存singletonFactories”结构是 Map&lt;String, ObjectFactory&lt;?&gt;&gt;，是一个工厂池，就是用来存放对象的代理工厂，代理工厂作用是存放半成品的单例 Bean，这样做是为了”破局”，即打破循环。</p>
<img src="/img/SpringCircularDependency/circulardependency4.jpg"/>

<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>为什么要这样设计呢？把二级缓存干掉不行么？<br>加入有serviceA、serviceB serviceC，并且serviceA中注入了serviceB serviceC，serviceB中注入了serviceA，serviceC中注入了serviceA，如果serviceA上加有事务或者Aop，因为代理对象每次都是生成不同的对象，如果干掉第二级缓存，只有第一、三级缓存，创建serviceB时依赖serviceA，工厂生成了一个serviceA1；创建serviceC时依赖serviceA，工厂生成了一个serviceA2；这就有问题了 serviceA 的工厂的代理对象，生成了两个不同的对象 serviceA1 和 serviceA2，所以为了避免这种问题的出现，spring搞了个二级缓存，把 serviceA 存下来，下次再获取时，直接从二级缓存获取，无需再生成新的代理对象。</p>
<h2 id="看完以后"><a href="#看完以后" class="headerlink" title="看完以后"></a>看完以后</h2><p>点赞，点赞是免费的，但却能激励我保持创作，还能帮助更多的人看到这篇文章。</p>
<p>留言，有任何问题，都可以在评论区留言，我会尽可能回复。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://xuchao6969.github.io">xuchao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://xuchao6969.github.io/2022/10/01/SpringCircularDependency/">https://xuchao6969.github.io/2022/10/01/SpringCircularDependency/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://xuchao6969.github.io" target="_blank">xuchaoのblog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring/">spring</a></div><div class="post_share"><div class="social-share" data-image="/img/xiaose6.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/09/03/OptimisticLockDeduceStockTest/"><img class="prev-cover" src="/img/tanglian1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">基于乐观锁实现的一个解决预约挂号,号源超卖的demo</div></div></a></div><div class="next-post pull-right"><a href="/2022/10/02/SpringBeanLifecycle/"><img class="next-cover" src="/img/zyz1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Spring bean的生命周期</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/10/03/SpringAop/" title="Spring Aop"><img class="cover" src="/img/shaosiming.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-03</div><div class="title">Spring Aop</div></div></a></div><div><a href="/2022/10/02/SpringBeanLifecycle/" title="Spring bean的生命周期"><img class="cover" src="/img/zyz1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-02</div><div class="title">Spring bean的生命周期</div></div></a></div><div><a href="/2023/01/21/SpringCloudAlibabaSeata/" title="SpringCloudAlibaba Seata实现分布式事务"><img class="cover" src="/img/xiaose5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-21</div><div class="title">SpringCloudAlibaba Seata实现分布式事务</div></div></a></div><div><a href="/2022/10/04/SpringTransactionManager/" title="Spring transaction manager"><img class="cover" src="/img/wuxin1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-04</div><div class="title">Spring transaction manager</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/leiwujie1.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">xuchao</div><div class="author-info__description">记录一下工作学习生活上的分享~~~ </div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xuchao6969"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xuchao6969" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:xucha_o@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-Circular-Dependency%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96"><span class="toc-number">1.</span> <span class="toc-text">Spring Circular Dependency循环依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96"><span class="toc-number">1.1.</span> <span class="toc-text">什么是循环依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%9A%84%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">循环依赖的条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.</span> <span class="toc-text">循环依赖的核心概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.</span> <span class="toc-text">调用流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spring%E7%9A%84%E7%89%88%E6%9C%AC%E6%98%AF5-3-23"><span class="toc-number">1.5.</span> <span class="toc-text">spring的版本是5.3.23</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.6.</span> <span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringApplication-run-SpringTransactionApplication-class-args"><span class="toc-number">1.6.1.</span> <span class="toc-text">SpringApplication.run(SpringTransactionApplication.class, args);</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractApplicationContext-refresh"><span class="toc-number">1.6.2.</span> <span class="toc-text">AbstractApplicationContext#refresh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractBeanFactory-doGetBean"><span class="toc-number">1.6.3.</span> <span class="toc-text">AbstractBeanFactory#doGetBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultSingletonBeanRegistry-getSingleton-String-beanName"><span class="toc-number">1.6.4.</span> <span class="toc-text">DefaultSingletonBeanRegistry#getSingleton(String beanName)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultSingletonBeanRegistry-getSingleton-String-beanName-ObjectFactory-lt-gt-singletonFactory"><span class="toc-number">1.6.5.</span> <span class="toc-text">DefaultSingletonBeanRegistry#getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractAutowireCapableBeanFactory-doCreateBean"><span class="toc-number">1.6.6.</span> <span class="toc-text">AbstractAutowireCapableBeanFactory#doCreateBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultSingletonBeanRegistry-addSingletonFactory"><span class="toc-number">1.6.7.</span> <span class="toc-text">DefaultSingletonBeanRegistry#addSingletonFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractAutoProxyCreator-wrapIfNecessary"><span class="toc-number">1.6.8.</span> <span class="toc-text">AbstractAutoProxyCreator#wrapIfNecessary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractAutowireCapableBeanFactory-populateBean"><span class="toc-number">1.6.9.</span> <span class="toc-text">AbstractAutowireCapableBeanFactory#populateBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AutowiredAnnotationBeanPostProcessor-postProcessProperties"><span class="toc-number">1.6.10.</span> <span class="toc-text">AutowiredAnnotationBeanPostProcessor#postProcessProperties</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InjectionMetadata-inject"><span class="toc-number">1.6.11.</span> <span class="toc-text">InjectionMetadata#inject</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AutowiredFieldElement-inject"><span class="toc-number">1.6.12.</span> <span class="toc-text">AutowiredFieldElement#inject</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AutowiredAnnotationBeanPostProcessor-resolveFieldValue"><span class="toc-number">1.6.13.</span> <span class="toc-text">AutowiredAnnotationBeanPostProcessor#resolveFieldValue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultListableBeanFactory-resolveDependency"><span class="toc-number">1.6.14.</span> <span class="toc-text">DefaultListableBeanFactory#resolveDependency</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultListableBeanFactory-doResolveDependency"><span class="toc-number">1.6.15.</span> <span class="toc-text">DefaultListableBeanFactory#doResolveDependency</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DependencyDescriptor-resolveCandidate"><span class="toc-number">1.6.16.</span> <span class="toc-text">DependencyDescriptor#resolveCandidate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractBeanFactory-doGetBean-1"><span class="toc-number">1.6.17.</span> <span class="toc-text">AbstractBeanFactory#doGetBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractBeanFactory-doGetBean-2"><span class="toc-number">1.6.18.</span> <span class="toc-text">AbstractBeanFactory#doGetBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultListableBeanFactory-getSingleton-String-beanName"><span class="toc-number">1.6.19.</span> <span class="toc-text">DefaultListableBeanFactory#getSingleton(String beanName)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultSingletonBeanRegistry-getSingleton-String-beanName-ObjectFactory-lt-gt-singletonFactory-1"><span class="toc-number">1.6.20.</span> <span class="toc-text">DefaultSingletonBeanRegistry#getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultSingletonBeanRegistry-addSingleton"><span class="toc-number">1.6.21.</span> <span class="toc-text">DefaultSingletonBeanRegistry#addSingleton</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultSingletonBeanRegistry-addSingleton-1"><span class="toc-number">1.6.22.</span> <span class="toc-text">DefaultSingletonBeanRegistry#addSingleton</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.7.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-number">1.8.</span> <span class="toc-text">思考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9C%8B%E5%AE%8C%E4%BB%A5%E5%90%8E"><span class="toc-number">1.9.</span> <span class="toc-text">看完以后</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/03/17/BurnTheRope/" title="一根不均匀的绳子，全部烧完需要1个小时，问怎样烧能计时1个小时15分钟"><img src="/img/yuhan1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一根不均匀的绳子，全部烧完需要1个小时，问怎样烧能计时1个小时15分钟"/></a><div class="content"><a class="title" href="/2023/03/17/BurnTheRope/" title="一根不均匀的绳子，全部烧完需要1个小时，问怎样烧能计时1个小时15分钟">一根不均匀的绳子，全部烧完需要1个小时，问怎样烧能计时1个小时15分钟</a><time datetime="2023-03-17T08:30:21.000Z" title="发表于 2023-03-17 16:30:21">2023-03-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/16/NucleicAcidDetection/" title="核酸检测混检为什么采用1管10个样本进行检查"><img src="/img/lihanyi.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="核酸检测混检为什么采用1管10个样本进行检查"/></a><div class="content"><a class="title" href="/2023/03/16/NucleicAcidDetection/" title="核酸检测混检为什么采用1管10个样本进行检查">核酸检测混检为什么采用1管10个样本进行检查</a><time datetime="2023-03-16T10:20:51.000Z" title="发表于 2023-03-16 18:20:51">2023-03-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/21/SpringCloudAlibabaSeata/" title="SpringCloudAlibaba Seata实现分布式事务"><img src="/img/xiaose5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringCloudAlibaba Seata实现分布式事务"/></a><div class="content"><a class="title" href="/2023/01/21/SpringCloudAlibabaSeata/" title="SpringCloudAlibaba Seata实现分布式事务">SpringCloudAlibaba Seata实现分布式事务</a><time datetime="2023-01-21T10:11:51.000Z" title="发表于 2023-01-21 18:11:51">2023-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/21/HexoBlogBackup/" title="Hexo 博客备份"><img src="/img/leiwujie1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hexo 博客备份"/></a><div class="content"><a class="title" href="/2022/11/21/HexoBlogBackup/" title="Hexo 博客备份">Hexo 博客备份</a><time datetime="2022-11-21T09:09:25.000Z" title="发表于 2022-11-21 17:09:25">2022-11-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/21/HexoConfigGiscus/" title="Hexo+Butterfly配置Giscus评论"><img src="/img/leiwujie.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hexo+Butterfly配置Giscus评论"/></a><div class="content"><a class="title" href="/2022/11/21/HexoConfigGiscus/" title="Hexo+Butterfly配置Giscus评论">Hexo+Butterfly配置Giscus评论</a><time datetime="2022-11-21T09:09:25.000Z" title="发表于 2022-11-21 17:09:25">2022-11-21</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/xiaose6.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023  <i id="heartbeat" class="fa fas fa-heartbeat"></i> xuchao</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadGiscus () {
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'xuchao6969/blog_giscus',
    'data-repo-id': 'R_kgDOIMjKeA',
    'data-category-id': 'DIC_kwDOIMjKeM4CR7sR',
    'data-mapping': 'pathname',
    'data-theme': nowTheme,
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme () {
  const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }

  sendMessage({
    setConfig: {
      theme: theme
    }
  });
}

if ('Giscus' === 'Giscus' || !false) {
  if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script async src="https://npm.elemecdn.com/tzy-blog/lib/js/other/sakura.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["link[rel=\"canonical\"]","meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script></div></body></html>